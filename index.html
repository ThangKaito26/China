<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chinese Mastery Hub - Giao di·ªán m·ªõi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load API Configuration -->
    <script src="config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #d946ef;
            /* Fuchsia-500 */
            --primary-hover: #c026d3;
            /* Fuchsia-600 */
            --primary-light: #fae8ff;
            /* Fuchsia-100 */
            --secondary: #db2777;
            /* Pink-600 */
            --text-primary: #1e293b;
            /* Slate-800 */
            --text-secondary: #475569;
            /* Slate-600 */
            --surface: #ffffff;
            --surface-alt: #f1f5f9;
            /* Slate-100 */
            --border: #e2e8f0;
            /* Slate-200 */
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        html.dark {
            --primary: #e879f9;
            /* Fuchsia-400 */
            --primary-hover: #d946ef;
            /* Fuchsia-500 */
            --text-primary: #f1f5f9;
            /* Slate-100 */
            --text-secondary: #94a3b8;
            /* Slate-400 */
            --surface: #1e293b;
            /* Slate-800 */
            --surface-alt: #334155;
            /* Slate-700 */
            --border: #475569;
            /* Slate-600 */
        }

        html.dark body {
            background-color: #0f172a;
            /* Slate-900 */
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23334155' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #f8fafc;
            /* Slate-50 */
            color: var(--text-primary);
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e2e8f0' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            background-attachment: fixed;
            transition: background-color 0.3s, color 0.3s;
        }

        .main-container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -0.025em;
        }

        .header h1 span {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            font-size: 1.125rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .lookup-card {
            background-color: var(--surface);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .input-group {
            display: flex;
            gap: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 0.5rem;
            transition: all 0.2s ease;
        }

        .input-group:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(217, 70, 239, 0.1);
        }

        .main-input {
            flex-grow: 1;
            border: none;
            outline: none;
            padding: 0.5rem 1rem;
            font-size: 1rem;
            background: transparent;
            color: var(--text-primary);
        }

        .icon-btn {
            background-color: transparent;
            border: none;
            padding: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .icon-btn:hover {
            background-color: var(--surface-alt);
            color: var(--text-primary);
        }

        .primary-btn {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .primary-btn:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .tabs-container {
            display: flex;
            gap: 0.5rem;
            border-bottom: 2px solid var(--border);
            margin-bottom: 1.5rem;
            overflow-x: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .tabs-container::-webkit-scrollbar {
            display: none;
        }

        .tab-btn {
            padding: 0.75rem 1.25rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-btn.active,
        .tab-btn:hover {
            color: var(--primary);
        }

        .tab-btn.active {
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.25rem;
        }

        .feature-btn {
            background-color: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-primary);
        }

        .feature-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
            color: var(--primary);
        }

        .feature-btn .icon {
            width: 2.25rem;
            height: 2.25rem;
            display: grid;
            place-items: center;
            border-radius: 0.5rem;
            background-color: var(--primary-light);
            color: var(--primary);
            flex-shrink: 0;
        }

        .feature-btn .pro-badge {
            background: linear-gradient(135deg, #facc15, #f59e0b);
            color: #422006;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 0.2rem 0.5rem;
            border-radius: 9999px;
            margin-left: auto;
            text-transform: uppercase;
        }

        .external-links {
            margin-top: 1.5rem;
            border-top: 1px solid var(--border);
            padding-top: 1.5rem;
        }

        .external-links-title {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .external-links .links-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .external-btn {
            background-color: var(--surface-alt);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .external-btn:hover {
            color: var(--primary);
            border-color: var(--primary-light);
            background-color: var(--primary-light);
        }

        .message-alert {
            margin-top: 1.5rem;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            font-weight: 500;
            text-align: center;
            display: none;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .message-alert.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .message-alert.error {
            background: #fee2e2;
            color: #dc2626;
            border-color: #fecaca;
        }

        .message-alert.info {
            background: #dbeafe;
            color: #2563eb;
            border-color: #bfdbfe;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .content-section {
            background: var(--surface);
            border-radius: 20px;
            padding: 2.5rem;
            margin: 2rem 0;
            max-width: 1000px;
            box-shadow: var(--shadow-lg);
            display: none;
            position: relative;
            overflow: hidden;
            animation: fadeIn 0.5s ease-out;
        }

        .section-header {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            padding-bottom: .75rem;
            border-bottom: 2px solid var(--border);
            display: flex;
            align-items: center;
            gap: .75rem
        }

        .loading-overlay {
            position: absolute;
            inset: 0;
            background: hsla(0, 0%, 100%, .95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 20px;
            transition: opacity .3s ease
        }

        html.dark .loading-overlay {
            background: rgba(30, 41, 59, 0.95);
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem
        }

        .loading-text {
            color: var(--primary);
            font-weight: 600;
            font-size: 1.125rem
        }

        @keyframes spin {
            0% {
                transform: rotate(0)
            }

            to {
                transform: rotate(360deg)
            }
        }

        .exercise-item,
        .question-item {
            background: var(--surface-alt);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all .3s ease
        }

        .exercise-item:hover,
        .question-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow)
        }

        .exercise-sentence,
        .question-text {
            font-size: 1.125rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 1rem;
            line-height: 1.7
        }

        .exercise-options,
        .question-options {
            display: flex;
            flex-wrap: wrap;
            gap: .75rem;
            margin-bottom: 1rem
        }

        .option-btn {
            background: var(--surface);
            color: var(--primary);
            border: 2px solid var(--primary-light);
            padding: .75rem 1.25rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: all .3s ease;
            position: relative
        }

        html.dark .option-btn {
            color: #f1f5f9;
            border-color: var(--border);
        }

        .option-btn:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
            background-color: var(--primary-light);
            box-shadow: 0 4px 12px rgba(217, 70, 239, 0.2)
        }

        .option-btn:disabled {
            cursor: not-allowed;
            opacity: .7
        }

        .option-btn:disabled:hover {
            transform: translateY(0);
            box-shadow: none;
            background-color: var(--surface)
        }

        .option-btn.correct {
            background: var(--secondary) !important;
            color: #fff !important;
            border-color: var(--secondary) !important
        }

        .option-btn.incorrect {
            background: #ef4444 !important;
            color: #fff !important;
            border-color: #dc2626 !important
        }

        .exercise-translation,
        .question-translation {
            font-style: italic;
            color: var(--text-secondary);
            font-size: .9rem
        }

        .exercise-feedback,
        .question-feedback {
            font-weight: 600;
            margin-top: 1rem;
            padding: .75rem 1rem;
            border-radius: 8px;
            background: var(--surface-alt)
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid var(--border)
        }

        th,
        td {
            padding: 1rem 1.25rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
            vertical-align: top
        }

        th {
            background: var(--surface-alt);
            font-weight: 600;
            color: var(--text-primary)
        }

        tr:last-child td {
            border-bottom: none
        }

        tr:hover {
            background: rgba(217, 70, 239, 0.05)
        }

        .info-card {
            background: var(--surface-alt);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: .75rem;
            display: flex;
            align-items: center;
            gap: .5rem
        }

        .card-title-alt {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: .5rem;
            color: var(--text-primary)
        }

        .conversation-container {
            min-height: 60vh;
            display: flex;
            flex-direction: column;
            background: var(--surface-alt);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden
        }

        .message-area {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem
        }

        .chat-message {
            max-width: 75%;
            padding: .875rem 1.25rem;
            border-radius: 18px;
            font-weight: 500;
            line-height: 1.5;
            animation: messageAppear .3s ease-out
        }

        .chat-message.ai {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-primary);
            align-self: flex-start;
            border-bottom-left-radius: 6px
        }

        .chat-message.user {
            background: var(--primary);
            color: #fff;
            align-self: flex-end;
            border-bottom-right-radius: 6px
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .chat-input-container {
            padding: 1rem 1.5rem;
            background: var(--surface);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 1rem
        }

        .chat-input {
            flex: 1;
            padding: .875rem 1.25rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            outline: none;
            font-size: 1rem;
            transition: all .3s ease;
            color: var(--text-primary);
            background-color: var(--surface-alt);
        }

        .chat-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(217, 70, 239, 0.1)
        }

        .chat-send-btn {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: .875rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all .3s ease
        }

        .chat-send-btn:hover {
            background: var(--primary-hover)
        }

        .audio-player {
            background: var(--surface-alt);
            border-radius: 16px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            border: 1px solid var(--border)
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 1rem
        }

        .audio-btn {
            background: var(--primary);
            color: #fff;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all .3s ease;
            box-shadow: var(--shadow)
        }

        .audio-btn:hover {
            background: var(--primary-hover);
            transform: scale(1.05)
        }

        .audio-btn:disabled {
            background-color: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
            opacity: .7
        }

        .audio-btn .spinning-loader {
            width: 24px;
            height: 24px;
            border: 3px solid hsla(0, 0%, 100%, .3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite
        }

        .audio-status {
            font-weight: 500;
            color: var(--text-secondary);
            min-width: 100px;
            text-align: center
        }

        .transcript-toggle-btn {
            background-color: var(--surface);
            color: var(--primary);
            border: 1px solid var(--primary-light);
            padding: .5rem 1rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: all .3s ease
        }

        .transcript-toggle-btn:hover {
            background-color: var(--primary-light)
        }

        .speaking-practice-card {
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center
        }

        .textarea-input {
            width: 100%;
            min-height: 100px;
            padding: 1rem;
            border-radius: 12px;
            border: 2px solid var(--border);
            font-size: 1rem;
            resize: vertical;
            background-color: var(--surface);
            color: var(--text-primary)
        }

        .textarea-input:focus {
            outline: none;
            border-color: var(--primary)
        }

        .pronunciation-record-btn {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: var(--shadow);
        }

        .pronunciation-record-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        .pronunciation-record-btn.recording {
            animation: pulse 1.5s infinite;
            background: #ef4444;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: var(--shadow);
            }

            50% {
                transform: scale(1.05);
                box-shadow: var(--shadow-lg);
            }

            100% {
                transform: scale(1);
                box-shadow: var(--shadow);
            }
        }

        .pronunciation-score-card {
            background: var(--surface);
            border: 2px solid var(--primary-light);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
        }

        .score-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            background: var(--primary-light);
            border: 5px solid var(--primary);
        }

        .chat-message .translation {
            font-size: 0.8rem;
            margin-top: 0.5rem;
            font-style: italic;
            color: var(--text-secondary);
            opacity: 0.8;
        }

        .chat-message.user .translation {
            color: #fbcfe8;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--surface);
            margin: auto;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 700px;
            animation: fadeInScale 0.3s ease-out;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .close-button {
            color: var(--text-secondary);
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--text-primary);
            text-decoration: none;
            cursor: pointer;
        }

        .correction-table th {
            background-color: var(--primary-light);
            color: var(--primary);
        }

        html.dark .correction-table th {
            background-color: #581c87;
            color: #f0abfc;
        }

        .correction-table td strong {
            color: var(--primary);
        }

        .unused-words-section {
            background: var(--surface-alt);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        #unusedWordsList {
            color: var(--text-secondary)
        }

        @media (max-width: 768px) {
            .main-container {
                margin: 1.5rem auto;
            }

            .lookup-card,
            .content-section {
                padding: 1.5rem;
            }

            .header h1 {
                font-size: 2.25rem;
            }

            .tab-btn {
                padding: 0.75rem 1rem;
            }
        }

        @media (max-width: 640px) {
            .main-container {
                margin: 1rem auto;
                padding: 0 0.75rem;
            }

            .header {
                margin-bottom: 1.5rem;
            }

            .header h1 {
                font-size: 1.875rem;
            }

            .header p {
                font-size: 1rem;
            }

            .lookup-card,
            .content-section {
                padding: 1rem;
                border-radius: 1rem;
            }

            .input-group {
                flex-wrap: wrap;
                gap: 0.75rem;
            }

            .main-input {
                flex-basis: 100%;
                order: 1;
                text-align: center;
            }

            .primary-btn {
                flex-basis: 100%;
                order: 3;
                justify-content: center;
            }

            .icon-btn {
                padding: 0.5rem;
            }

            .input-group>.icon-btn:first-of-type {
                order: 2;
                margin-left: auto;
            }

            .input-group>.icon-btn:nth-of-type(2) {
                order: 2;
                margin-right: auto;
            }

            .features-grid {
                grid-template-columns: 1fr;
            }

            .content-section {
                padding: 1.5rem 1rem;
            }

            .section-header {
                font-size: 1.5rem;
            }

            .practice-actions {
                gap: 0.5rem;
                flex-wrap: wrap;
                justify-content: center;
            }

            .practice-actions .feature-btn,
            .practice-actions .primary-btn,
            .pronunciation-record-btn {
                padding: 0.75rem 1.25rem;
                font-size: 0.875rem;
                flex-grow: 0;
                justify-content: center;
            }
        }
    </style>
</head>

<body class="transition-colors duration-300">

    <div class="main-container">
        <header class="header relative">
            <div class="absolute top-0 right-0">
                <button id="theme-toggle" class="icon-btn p-2 rounded-full" title="Chuy·ªÉn ch·∫ø ƒë·ªô S√°ng/T·ªëi">
                    <svg id="theme-toggle-dark-icon" class="hidden h-6 w-6" fill="currentColor" viewBox="0 0 20 20"
                        xmlns="http://www.w3.org/2000/svg">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                    </svg>
                    <svg id="theme-toggle-light-icon" class="hidden h-6 w-6" fill="currentColor" viewBox="0 0 20 20"
                        xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z"
                            fill-rule="evenodd" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            <h1>Ch√†o m·ª´ng ƒë·∫øn v·ªõi <span>Chinese Mastery Hub</span></h1>
            <p>C√¥ng c·ª• h·ªçc ti·∫øng Trung to√†n di·ªán, t·∫≠p trung v√†o Nghe & N√≥i</p>
        </header>

        <div class="lookup-card">
            <div class="input-group">
                <input type="text" class="main-input" id="vocabularyInput"
                    placeholder="Nh·∫≠p t·ª´ Ti·∫øng Vi·ªát, Pinyin, ho·∫∑c ch·ªß ƒë·ªÅ...">
                <button class="icon-btn" id="btnPasteClipboard" title="D√°n t·ª´ clipboard">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                        viewBox="0 0 16 16">
                        <path
                            d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z" />
                        <path
                            d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z" />
                    </svg>
                </button>
                <button class="icon-btn" id="btnClearInput" title="X√≥a n·ªôi dung">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                        viewBox="0 0 16 16">
                        <path
                            d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z" />
                        <path fill-rule="evenodd"
                            d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z" />
                    </svg>
                </button>
                <button class="primary-btn" id="btnQuickSearch">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        <path d="M8 11.5v-3"></path>
                        <path d="M14 11.5v-3"></path>
                    </svg>
                    Tra & Nghe
                </button>
            </div>
            <div class="message-alert" id="messageBox"></div>
            <div id="quickSearchResults" class="mt-4"></div>

            <div class="tabs-container">
                <button class="tab-btn active" data-tab="tab-learn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                    </svg>
                    H·ªçc & Luy·ªán T·∫≠p
                </button>
                <button class="tab-btn" data-tab="tab-create">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 20h9"></path>
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                    </svg>
                    S√°ng T·∫°o
                </button>
                <button class="tab-btn" data-tab="tab-analyze">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="20" x2="18" y2="10"></line>
                        <line x1="12" y1="20" x2="12" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="14"></line>
                    </svg>
                    Ph√¢n T√≠ch
                </button>
                <button class="tab-btn" data-tab="tab-interactive">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 18a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2"></path>
                        <rect x="3" y="4" width="18" height="18" rx="2"></rect>
                        <circle cx="12" cy="10" r="2"></circle>
                        <line x1="8" y1="2" x2="8" y2="4"></line>
                        <line x1="16" y1="2" x2="16" y2="4"></line>
                    </svg>
                    T∆∞∆°ng T√°c AI
                </button>
            </div>

            <div id="tab-learn" class="tab-content active">
                <div class="features-grid">
                    <button class="feature-btn" id="btnGenerateExplanation"><span class="icon">üìö</span><span>Gi·∫£i th√≠ch
                            T·ª´ v·ª±ng / Ng·ªØ ph√°p</span></button>
                    <button class="feature-btn" id="btnGenerateExamples"><span class="icon">üí°</span><span>T·∫°o V√≠ d·ª•
                            theo Ng·ªØ c·∫£nh</span></button>
                    <button class="feature-btn" id="btnGenerateExercise"><span class="icon">‚úçÔ∏è</span><span>B√†i t·∫≠p ƒêi·ªÅn
                            t·ª´ & Tr·∫Øc nghi·ªám</span></button>
                    <button class="feature-btn" id="btnGenerateListeningFillInTheBlank"><span
                            class="icon">üéß</span><span>B√†i t·∫≠p Nghe & ƒêi·ªÅn t·ª´</span></button>
                    <button class="feature-btn" id="btnGenerateReadingAndQuestions"><span
                            class="icon">üìñ</span><span>B√†i ƒë·ªçc (Pinyin) & C√¢u h·ªèi</span></button>
                    <button class="feature-btn" id="btnGenerateListeningAndQuestions"><span
                            class="icon">üó£Ô∏è</span><span>B√†i nghe & C√¢u h·ªèi</span></button>
                </div>
            </div>

            <div id="tab-create" class="tab-content">
                <div class="features-grid">
                    <button class="feature-btn" id="btnCorrectPinyin"><span class="icon">üìù</span><span>S·ª≠a l·ªói Pinyin
                            <span class="pro-badge">PRO</span></span></button>
                    <button class="feature-btn" id="btnGenerateDialogue"><span class="icon">üí¨</span><span>T·∫°o ƒêo·∫°n H·ªôi
                            tho·∫°i</span></button>
                    <button class="feature-btn" id="btnGenerateParagraphs"><span class="icon">üìÑ</span><span>Vi·∫øt ƒêo·∫°n
                            vƒÉn theo T·ª´ kh√≥a</span></button>
                    <button class="feature-btn" id="btnSummarizeText"><span class="icon">üìã</span><span>T√≥m t·∫Øt VƒÉn b·∫£n
                            (Pinyin)</span></button>
                    <button class="feature-btn" id="btnGenerateSituationalSentences"><span
                            class="icon">üìß</span><span>T·∫°o c√¢u theo T√¨nh hu·ªëng</span></button>
                </div>
            </div>

            <div id="tab-analyze" class="tab-content">
                <div class="features-grid">
                    <button class="feature-btn" id="btnCompareVocabulary"><span class="icon">‚öñÔ∏è</span><span>So s√°nh c√°c
                            T·ª´ Pinyin t∆∞∆°ng t·ª±</span></button>
                    <button class="feature-btn" id="btnAnalyzeTones"><span class="icon">üé≠</span><span>Ph√¢n t√≠ch Thanh
                            ƒëi·ªáu (Tones)</span></button>
                    <button class="feature-btn" id="btnCheckPopularity"><span class="icon">üìä</span><span>Ki·ªÉm tra M·ª©c
                            ƒë·ªô Ph·ªï Bi·∫øn</span></button>
                    <button class="feature-btn" id="btnTranslateSentence"><span class="icon">üîÅ</span><span>D·ªãch c√¢u
                            Vi·ªát - Trung</span></button>
                </div>
            </div>

            <div id="tab-interactive" class="tab-content">
                <div class="features-grid">
                    <button class="feature-btn" id="btnStartConversationSimulator"><span class="icon">ü§ñ</span><span>M√¥
                            ph·ªèng H·ªôi tho·∫°i v·ªõi AI</span></button>
                    <button class="feature-btn" id="btnStartSpeakingPractice"><span class="icon">üéôÔ∏è</span><span>Luy·ªán
                            ph·∫£n x·∫° n√≥i (AI)</span></button>
                    <button class="feature-btn" id="btnStartPinyinPractice"><span class="icon">‚úçÔ∏è</span><span>Luy·ªán g√µ
                            Pinyin (AI)</span></button>
                    <button class="feature-btn" id="btnStartSpeakingPracticeManual"><span
                            class="icon">üó£Ô∏è</span><span>Luy·ªán ph·∫£n x·∫° (Th·ªß c√¥ng)</span></button>
                </div>
            </div>

            <div class="external-links">
                <h3 class="external-links-title">C√¥ng c·ª• tra c·ª©u b√™n ngo√†i</h3>
                <div class="links-group">
                    <button class="external-btn" id="btnGoogleTranslate">Google D·ªãch</button>
                    <button class="external-btn" id="btnPleco">T·ª´ ƒëi·ªÉn Pleco (web)</button>
                    <button class="external-btn" id="btnForvo">Forvo (Ph√°t √¢m)</button>
                    <button class="external-btn" id="btnGoogleImages">Google H√¨nh ·∫£nh</button>
                    <button class="external-btn" id="btnYouglish">YouGlish (Ph√°t √¢m th·ª±c t·∫ø)</button>
                </div>
            </div>

        </div>
    </div>

    <div id="content-results-area" class="main-container">
    </div>

    <div id="correctionModal" class="modal">
        <div class="modal-content">
            <span id="closeCorrectionModal" class="close-button">&times;</span>
            <h2 class="text-xl font-bold mb-4 text-fuchsia-600">Ki·ªÉm tra & S·ª≠a l·ªói</h2>
            <div id="modalCorrectionContent">
            </div>
        </div>
    </div>

    <div id="manualSpeakingModal" class="modal">
        <div class="modal-content">
            <span id="closeManualSpeakingModal" class="close-button">&times;</span>
            <h2 class="text-xl font-bold mb-4 text-fuchsia-600">Luy·ªán ph·∫£n x·∫° (Th·ªß c√¥ng)</h2>
            <div class="info-card mb-4">
                <p class="mb-2 font-semibold">Nh·∫≠p c√°c c√¢u ti·∫øng Vi·ªát b·∫°n mu·ªën luy·ªán t·∫≠p, m·ªói c√¢u m·ªôt d√≤ng:</p>
                <textarea id="manualSentencesInput" class="textarea-input" rows="8"
                    placeholder="V√≠ d·ª•:&#10;H√¥m nay th·ªùi ti·∫øt r·∫•t ƒë·∫πp.&#10;T√¥i ƒëang h·ªçc ti·∫øng Trung.&#10;B·∫°n c√≥ kh·ªèe kh√¥ng?"></textarea>
            </div>
            <div class="flex justify-end gap-3">
                <button id="startManualPracticeBtn" class="primary-btn">B·∫Øt ƒë·∫ßu Luy·ªán t·∫≠p</button>
            </div>
        </div>
    </div>


    <script>
        // --- Theme Toggle Logic ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

        const applyTheme = () => {
            if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                themeToggleLightIcon.classList.remove('hidden');
                themeToggleDarkIcon.classList.add('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                themeToggleDarkIcon.classList.remove('hidden');
                themeToggleLightIcon.classList.add('hidden');
            }
        };

        themeToggleBtn.addEventListener('click', function () {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('color-theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            applyTheme();
        });

        // --- Tabbed Interface Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            applyTheme();

            const tabs = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                });
            });
            attachEventListeners();
        });


        // --- Global State ---
        let conversationHistory = [];
        let currentUtteranceQueue = [];
        let isSpeakingFullDialogue = false;
        let recognition; // Global variable for SpeechRecognition instance
        let isRecording = false; // To track recording state
        const loopPlaybackState = { active: false, text: '', button: null };

        // --- DOM Element References ---
        const vocabularyInput = document.getElementById('vocabularyInput');
        const messageBox = document.getElementById('messageBox');
        const contentResultsArea = document.getElementById('content-results-area');
        const quickSearchResults = document.getElementById('quickSearchResults');
        const correctionModal = document.getElementById('correctionModal');
        const closeCorrectionModalBtn = document.getElementById('closeCorrectionModal');
        const modalCorrectionContent = document.getElementById('modalCorrectionContent');
        const contentContainers = {};

        // --- UI Helper Functions ---
        function hideAllSections() {
            stopLoopPlayback();
            if (speechSynthesis.speaking || speechSynthesis.pending) {
                speechSynthesis.cancel();
            }
            if (recognition && typeof recognition.abort === 'function') {
                recognition.abort();
            }
            currentUtteranceQueue = [];
            isSpeakingFullDialogue = false;

            if (isRecording) {
                if (recognition) recognition.stop();
                isRecording = false;
                const recordBtn = document.getElementById('record-pronunciation-btn');
                if (recordBtn) {
                    recordBtn.classList.remove('recording');
                    recordBtn.querySelector('span').textContent = 'Ghi √¢m & Ch·∫•m ƒëi·ªÉm';
                }
            }

            contentResultsArea.innerHTML = '';
            quickSearchResults.innerHTML = '';
            Object.keys(contentContainers).forEach(key => delete contentContainers[key]);
        }

        function createContentSection(featureKey, headerText) {
            hideAllSections();
            const containerId = `${featureKey}Container`;
            const overlayId = `${featureKey}LoadingOverlay`;
            const contentId = `${featureKey}Content`;

            const sectionHTML = `
                <div class="content-section" id="${containerId}" style="display: block;">
                    <div class="loading-overlay" id="${overlayId}">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">${headerText}...</div>
                    </div>
                    <div id="${contentId}"></div>
                </div>
            `;
            contentResultsArea.innerHTML = sectionHTML;

            contentContainers[featureKey] = {
                container: document.getElementById(containerId),
                overlay: document.getElementById(overlayId),
                content: document.getElementById(contentId)
            };

            document.getElementById(containerId).scrollIntoView({ behavior: 'smooth', block: 'start' });

            return contentContainers[featureKey];
        }

        function showMessage(message, type = 'error') {
            messageBox.textContent = message;
            messageBox.className = `message-alert show ${type}`;
        }

        function hideMessage() {
            messageBox.className = 'message-alert';
        }

        function clearInput() {
            vocabularyInput.value = '';
            hideMessage();
            vocabularyInput.focus();
            hideAllSections();
        }

        async function pasteFromClipboard() {
            hideMessage();
            if (!navigator.clipboard?.readText) {
                showMessage('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ d√°n t·ª± ƒë·ªông. Vui l√≤ng d√πng t·ªï h·ª£p ph√≠m Ctrl+V.', 'error');
                return;
            }
            try {
                const text = await navigator.clipboard.readText();
                vocabularyInput.value = text;
                showMessage('ƒê√£ d√°n th√†nh c√¥ng!', 'info');
            } catch (err) {
                console.error('L·ªói khi d√°n:', err);
                showMessage('D√°n t·ª± ƒë·ªông b·ªã ch·∫∑n b·ªüi tr√¨nh duy·ªát. Vui l√≤ng d√πng Ctrl+V ho·∫∑c Cmd+V ƒë·ªÉ d√°n.', 'error');
            }
        }

        // --- Main Feature Functions ---
        function openLink(type) {
            const vocabulary = vocabularyInput.value.trim();
            if (!vocabulary) {
                showMessage('Vui l√≤ng nh·∫≠p t·ª´ v·ª±ng ƒë·ªÉ t√¨m ki·∫øm.', 'error');
                return;
            }
            const urls = {
                googleTranslate: `https://translate.google.com/?sl=zh-CN&tl=vi&text=${encodeURIComponent(vocabulary)}&op=translate`,
                pleco: `https://www.pleco.com/`, // Pleco is an app, linking to its homepage.
                forvo: `https://forvo.com/search/${encodeURIComponent(vocabulary)}/zh/`,
                googleImages: `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(vocabulary)}`,
                youglish: `https://youglish.com/pronounce/${encodeURIComponent(vocabulary)}/chinese`
            };
            if (urls[type]) {
                window.open(urls[type], '_blank');
            }
        }

        async function callGemini(prompt, schema = null) {
            // Check if config is loaded
            if (!window.CONFIG || !window.CONFIG.OPENROUTER_API_KEY) {
                throw new Error('Thi·∫øu file config.js! Vui l√≤ng t·∫°o file config.js t·ª´ config.example.js v√† th√™m API key c·ªßa b·∫°n.');
            }

            // Check if API key is still placeholder
            if (window.CONFIG.OPENROUTER_API_KEY === 'YOUR_OPENROUTER_API_KEY_HERE') {
                throw new Error('Vui l√≤ng thay th·∫ø API key trong file config.js b·∫±ng key th·∫≠t c·ªßa b·∫°n. L·∫•y key mi·ªÖn ph√≠ t·∫°i: https://openrouter.ai/keys');
            }

            // OpenRouter API configuration
            const apiKey = window.CONFIG.OPENROUTER_API_KEY;
            const apiUrl = window.CONFIG.API_URL || "https://openrouter.ai/api/v1/chat/completions";

            // Prepare the system message for JSON schema if provided
            let systemMessage = "You are a helpful assistant that responds in JSON format.";
            if (schema) {
                systemMessage += " You must respond ONLY with valid JSON that matches the requested schema. Do not include any markdown formatting, code blocks, or explanatory text - just the raw JSON object.";
            }

            // Add JSON instruction to the prompt
            let enhancedPrompt = prompt;
            if (schema) {
                enhancedPrompt += "\n\nIMPORTANT: Respond with ONLY valid JSON. Do not wrap it in markdown code blocks or add any other text.";
            }

            // Build the payload for OpenRouter API
            const payload = {
                model: window.CONFIG.MODEL || "openai/gpt-4o-mini-2024-07-18",
                messages: [
                    {
                        role: "system",
                        content: systemMessage
                    },
                    {
                        role: "user",
                        content: enhancedPrompt
                    }
                ],
                temperature: 0.7,
                response_format: { type: "json_object" }
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`,
                    'HTTP-Referer': window.location.href,
                    'X-Title': 'Chinese Mastery Hub'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                console.error("API Error Response:", errorBody);
                throw new Error(`L·ªói API: ${response.status} ${response.statusText}`);
            }

            const result = await response.json();

            if (result.choices && result.choices[0]?.message?.content) {
                let text = result.choices[0].message.content.trim();

                // Remove markdown code blocks if present
                if (text.startsWith('```json')) {
                    text = text.replace(/^```json\s*\n/, '').replace(/\n```\s*$/, '');
                } else if (text.startsWith('```')) {
                    text = text.replace(/^```\s*\n/, '').replace(/\n```\s*$/, '');
                }

                try {
                    let parsedData = JSON.parse(text);

                    // Handle cases where the response is wrapped in an extra object
                    // For example: { "examples": [...] } or { "data": {...} }
                    if (parsedData && typeof parsedData === 'object' && !Array.isArray(parsedData)) {
                        const keys = Object.keys(parsedData);
                        // If there's only one key and its value is an array or object, unwrap it
                        if (keys.length === 1 && (Array.isArray(parsedData[keys[0]]) || typeof parsedData[keys[0]] === 'object')) {
                            console.log('Unwrapping nested response from key:', keys[0]);
                            parsedData = parsedData[keys[0]];
                        }
                    }

                    return parsedData;
                } catch (e) {
                    console.error("L·ªói ph√¢n t√≠ch JSON:", e, "D·ªØ li·ªáu g·ªëc:", text);
                    throw new Error("Kh√¥ng th·ªÉ ph√¢n t√≠ch ph·∫£n h·ªìi t·ª´ API. Ph·∫£n h·ªìi kh√¥ng ph·∫£i l√† JSON h·ª£p l·ªá.");
                }
            }
            console.error("Ph·∫£n h·ªìi API kh√¥ng h·ª£p l·ªá:", result);
            throw new Error('C·∫•u tr√∫c ph·∫£n h·ªìi API kh√¥ng mong ƒë·ª£i ho·∫∑c tr·ªëng.');
        }

        async function handleFeature(featureKey, headerText, promptGenerator, renderer, inputValidator = (input) => !!input) {
            const { container, content, overlay } = createContentSection(featureKey, `ƒêang ${headerText.toLowerCase()}`);

            let featureInput;
            if (featureKey === 'speakingPracticeManual') {
                featureInput = arguments[arguments.length - 1];
            } else {
                featureInput = vocabularyInput.value.trim();
            }

            if (!inputValidator(featureInput)) {
                showMessage(`Vui l√≤ng nh·∫≠p ƒë·∫ßu v√†o h·ª£p l·ªá cho ch·ª©c nƒÉng n√†y.`, 'error');
                hideAllSections();
                return;
            }

            try {
                if (['conversationSimulator', 'speakingPractice', 'speakingPracticeManual', 'pinyinPractice'].includes(featureKey)) {
                    await renderer(featureInput, content, headerText);
                } else {
                    const { prompt, schema } = promptGenerator(featureInput);
                    const data = await callGemini(prompt, schema);
                    // Debug logging for explanation feature
                    if (featureKey === 'explanation') {
                        console.log('Explanation API Response:', data);
                        console.log('Has synonyms:', !!data.synonyms, data.synonyms);
                        console.log('Has antonyms:', !!data.antonyms, data.antonyms);
                        console.log('Has collocations:', !!data.collocations, data.collocations);
                    }
                    renderer(data, content, headerText, featureInput);
                }
            } catch (error) {
                showMessage(`C√≥ l·ªói x·∫£y ra khi t·∫°o n·ªôi dung. Vui l√≤ng th·ª≠ l·∫°i.`, 'error');
                console.error(`L·ªói v·ªõi ch·ª©c nƒÉng ${featureKey}:`, error);
                content.innerHTML = `<p class="text-red-500 font-semibold">ƒê√£ x·∫£y ra l·ªói: ${error.message}</p>`;
            } finally {
                if (overlay) overlay.style.display = 'none';
            }
        }

        // --- RENDERERS ---
        const renderers = {
            quickLookup: (data, el) => {
                el.innerHTML = `
                    <div class="info-card p-4">
                      <div class="flex items-center gap-4">
                         <button class="audio-btn" style="width: 44px; height: 44px; min-width: 44px;" onclick="speakText('${data.hanzi.replace(/'/g, "\\'")}')" title="Nghe l·∫°i">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-1.414 1.414A6.472 6.472 0 0 1 12.026 8c0 1.966-.893 3.738-2.29 4.949l1.414 1.414z"/><path d="M10.121 12.596A6.48 6.48 0 0 0 12.026 8a6.48 6.48 0 0 0-1.905-4.596l-1.414 1.414A4.486 4.486 0 0 1 10.026 8c0 1.353-.6 2.544-1.515 3.328l1.414 1.414zM8.707 11.182A4.5 4.5 0 0 0 10.026 8a4.5 4.5 0 0 0-1.319-3.182L8.707 5.18a2.5 2.5 0 0 1 0 5.64l.001.002zM6.343 4.828a.5.5 0 0 0 0 .707L7.05 6.243a.5.5 0 0 0 .707 0l.707-.707a.5.5 0 0 0 0-.707L7.757 4.12a.5.5 0 0 0-.707 0l-.708.707zM4.717 6.464a.5.5 0 0 0 0 .708L5.424 7.88a.5.5 0 0 0 .707 0l.707-.707a.5.5 0 0 0 0-.708L6.128 5.757a.5.5 0 0 0-.707 0l-.708.707zM2 8a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1A.5.5 0 0 1 2 8z"/></svg>
                         </button>
                         <div>
                            <p class="text-xl font-semibold text-fuchsia-600 dark:text-fuchsia-400">${data.pinyin}</p>
                            <p class="mt-1 text-lg">${data.meaning}</p>
                         </div>
                      </div>
                    </div>
                `;
            },
            examples: (data, el, headerText) => {
                el.innerHTML = `
                    <h2 class="section-header">üí° ${headerText}</h2>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Pinyin</th><th>Ti·∫øng Vi·ªát</th><th>Ph√°t √¢m</th></tr></thead>
                            <tbody>
                            ${data.map(item => `
                                <tr>
                                    <td class="font-mono">${item.pinyin}</td>
                                    <td>${item.vietnamese}</td>
                                    <td>
                                        <button class="icon-btn" onclick="speakText('${item.hanzi.replace(/'/g, "\\'")}')" title="Nghe c√¢u n√†y">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-1.414 1.414A6.472 6.472 0 0 1 12.026 8c0 1.966-.893 3.738-2.29 4.949l1.414 1.414zM8.707 11.182A4.5 4.5 0 0 0 10.026 8a4.5 4.5 0 0 0-1.319-3.182L8.707 5.18a2.5 2.5 0 0 1 0 5.64l.001.002z"/></svg>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            },
            exercise: (data, el, headerText) => {
                el.innerHTML = `<h2 class="section-header">‚ú® ${headerText}</h2>` + data.map(item => `
                    <div class="exercise-item" data-hanzi="${item.hanzi_sentence.replace(/"/g, '&quot;')}">
                        <p class="exercise-sentence font-mono">${item.id}. ${item.pinyin_with_blank}</p>
                        <div class="exercise-options">${item.options.map(option => `<button class="option-btn font-mono" data-value="${option.replace(/"/g, '&quot;')}" onclick="checkFillInBlankAnswer(this, '${item.correct_word_pinyin.replace(/'/g, "\\'")}')">${option}</button>`).join('')}</div>
                        <p class="exercise-translation">(D·ªãch: ${item.translation})</p>
                        <div class="exercise-feedback"></div>
                    </div>`).join('');
            },
            listeningFillInTheBlank: (data, el, headerText) => {
                el.innerHTML = `<h2 class="section-header">üéß ${headerText}</h2>` + data.map(item => `
                    <div class="exercise-item">
                        <div class="flex items-center gap-4 mb-4">
                             <button class="audio-btn" onclick="playQuestionAudio(this, '${item.hanzi_sentence.replace(/'/g, "\\'")}')" title="Nghe c√¢u">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M10.804 8 5 4.633v6.734L10.804 8zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm15 0a7 7 0 1 0-14 0 7 7 0 0 0 14 0z"/></svg>
                             </button>
                             <p class="exercise-sentence flex-1 font-mono">${item.id}. ${item.pinyin_with_blank}</p>
                        </div>
                        <div class="exercise-options">${item.options.map(option => `<button class="option-btn font-mono" data-value="${option.replace(/"/g, '&quot;')}" onclick="checkFillInBlankAnswer(this, '${item.correct_word_pinyin.replace(/'/g, "\\'")}')">${option}</button>`).join('')}</div>
                        <p class="exercise-translation">(D·ªãch: ${item.translation})</p>
                        <div class="exercise-feedback"></div>
                    </div>`).join('');
            },
            explanation: (data, el, headerText, originalInput) => {
                // Ensure data has all required fields with defaults
                if (!data) {
                    console.error('Explanation data is null or undefined');
                    data = {};
                }
                data.synonyms = data.synonyms || [];
                data.antonyms = data.antonyms || [];
                data.collocations = data.collocations || [];
                data.memory_tips = data.memory_tips || [];

                console.log('Rendering explanation with data:', {
                    hasSynonyms: data.synonyms?.length || 0,
                    hasAntonyms: data.antonyms?.length || 0,
                    hasCollocations: data.collocations?.length || 0,
                    hasMemoryTips: data.memory_tips?.length || 0
                });

                const renderStars = (rating) => {
                    const fullStars = Math.round(rating);
                    const emptyStars = 5 - fullStars;
                    return '‚òÖ'.repeat(fullStars) + '‚òÜ'.repeat(emptyStars);
                };

                const renderWordList = (items, title, icon, alwaysShow = false) => {
                    if (!items || !Array.isArray(items) || items.length === 0) {
                        if (alwaysShow) {
                            return `
                                <div class="info-card">
                                    <h3 class="card-title">${icon} ${title}</h3>
                                    <div class="space-y-3">
                                        <p class="text-slate-500 dark:text-slate-400 italic text-center py-4">Ch∆∞a c√≥ d·ªØ li·ªáu</p>
                                    </div>
                                </div>
                            `;
                        }
                        return '';
                    }
                    return `
                        <div class="info-card">
                            <h3 class="card-title">${icon} ${title}</h3>
                            <div class="space-y-3">
                                ${items.map(item => {
                        const escapedPinyin = String(item.pinyin || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        const escapedHanzi = String(item.hanzi || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        const escapedMeaning = String(item.meaning || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        const rating = Number(item.rating) || 0;
                        return `
                                        <div class="flex items-center justify-between py-2 border-b border-slate-200 dark:border-slate-700 last:border-b-0">
                                            <div class="flex-1">
                                                <p class="font-mono text-slate-800 dark:text-slate-200">${escapedPinyin}</p>
                                                <p class="text-slate-600 dark:text-slate-400">${escapedHanzi}</p>
                                                <p class="text-sm text-slate-500 dark:text-slate-500 italic">${escapedMeaning}</p>
                                            </div>
                                            <div class="ml-4 text-yellow-500 text-lg" title="ƒê√°nh gi√°: ${rating}/5">
                                                ${renderStars(rating)}
                                            </div>
                                        </div>
                                    `;
                    }).join('')}
                            </div>
                        </div>
                    `;
                };

                const memoryTipsSection = data.memory_tips && Array.isArray(data.memory_tips) && data.memory_tips.length > 0 ? `
                    <div class="info-card">
                        <h3 class="card-title">üí° M·∫πo ƒë·ªÉ d·ªÖ nh·ªõ</h3>
                        <ul class="list-disc list-inside space-y-2">
                            ${data.memory_tips.map(tip => `<li class="text-slate-800 dark:text-slate-200">${String(tip).replace(/</g, '&lt;').replace(/>/g, '&gt;')}</li>`).join('')}
                        </ul>
                    </div>
                ` : '';

                const synonymsSection = renderWordList(data.synonyms, 'T·ª´ ƒë·ªìng nghƒ©a', 'üëç', true);
                const antonymsSection = renderWordList(data.antonyms, 'T·ª´ tr√°i nghƒ©a', 'üëé', true);

                // Render collocations as a table, sorted by rating (highest first)
                const collocationsSection = (() => {
                    if (!data.collocations || !Array.isArray(data.collocations) || data.collocations.length === 0) {
                        return `
                            <div class="info-card">
                                <h3 class="card-title">ü§ù C√°ch d√πng ph·ªï bi·∫øn (Collocations)</h3>
                                <div class="table-container">
                                    <p class="text-slate-500 dark:text-slate-400 italic text-center py-4">Ch∆∞a c√≥ d·ªØ li·ªáu</p>
                                </div>
                            </div>
                        `;
                    }

                    // Sort by rating descending
                    const sortedCollocations = [...data.collocations].sort((a, b) => {
                        const ratingA = Number(a.rating) || 0;
                        const ratingB = Number(b.rating) || 0;
                        return ratingB - ratingA;
                    });

                    return `
                        <div class="info-card">
                            <h3 class="card-title">ü§ù C√°ch d√πng ph·ªï bi·∫øn (Collocations)</h3>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Pinyin</th>
                                            <th>Ch·ªØ H√°n</th>
                                            <th>Nghƒ©a</th>
                                            <th>M·ª©c ƒë·ªô ph·ªï bi·∫øn</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${sortedCollocations.map(item => {
                        const escapedPinyin = String(item.pinyin || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        const escapedHanzi = String(item.hanzi || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        const escapedMeaning = String(item.meaning || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        const rating = Number(item.rating) || 0;
                        return `
                                                <tr>
                                                    <td class="font-mono">${escapedPinyin}</td>
                                                    <td>${escapedHanzi}</td>
                                                    <td>${escapedMeaning}</td>
                                                    <td class="text-yellow-500 text-lg" title="ƒê√°nh gi√°: ${rating}/5">${renderStars(rating)}</td>
                                                </tr>
                                            `;
                    }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                })();

                const speakTarget = (data.hanzi || data.hanzi_word || originalInput || '').trim();
                const speakButtonHtml = speakTarget ? `
                    <button class="primary-btn flex-shrink-0" onclick="speakText('${speakTarget.replace(/'/g, "\\'")}')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 9v6h4l5 4V5l-5 4H5z"></path><line x1="16" y1="8" x2="16" y2="16"></line><line x1="20" y1="5" x2="20" y2="19"></line></svg>
                        Nghe c·ª•m t·ª´
                    </button>
                ` : '';
                const loopButtonHtml = speakTarget ? `
                    <button class="feature-btn justify-center" data-loop-default="üîÅ Nghe li√™n t·ª•c" data-loop-stop="‚èπ D·ª´ng l·∫∑p" data-loop-state="stopped" onclick="toggleLoopPlayback(this, '${speakTarget.replace(/'/g, "\\'")}')">
                        üîÅ Nghe li√™n t·ª•c
                    </button>
                ` : '';
                const audioControlsHtml = speakTarget ? `
                    <div class="flex flex-col gap-2 w-full md:w-auto">
                        ${speakButtonHtml}
                        ${loopButtonHtml}
                    </div>
                ` : '';

                el.innerHTML = `
                    <h2 class="section-header">üìö ${headerText}: ${originalInput}</h2>
                    <div class="info-card">
                        <h3 class="card-title">üìñ Gi·∫£i th√≠ch chung</h3>
                        <div class="flex flex-col md:flex-row md:items-center gap-4">
                            <p class="flex-1">${data.explanation}</p>
                            ${audioControlsHtml}
                        </div>
                    </div>
                    <div class="info-card">
                        <h3 class="card-title">üîç Ph√¢n t√≠ch t·ª´ng th√†nh ph·∫ßn</h3>
                        <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Pinyin</th>
                                    <th>Ch·ªØ H√°n</th>
                                    <th>Nghƒ©a g·ªëc</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.components.map(item => `
                                    <tr>
                                        <td class="font-mono">${item.pinyin}</td>
                                        <td>${item.hanzi}</td>
                                        <td>${item.meaning}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        </div>
                    </div>
                    ${data.component_examples ? `
                    <div class="info-card">
                        <h3 class="card-title">üìñ V√≠ d·ª• m·ªü r·ªông theo t·ª´ng ch·ªØ H√°n</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th style="width: 100px;">Th√†nh ph·∫ßn</th>
                                        <th style="width: 140px;">V√≠ d·ª•</th>
                                        <th style="width: 180px;">Pinyin</th>
                                        <th>Nghƒ©a ti·∫øng Vi·ªát</th>
                                        <th style="width: 60px;">Ph√°t √¢m</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.entries(data.component_examples).map(([char, examples]) => {
                    return examples.map((ex, idx) => `
                                            <tr class="${idx === 0 ? 'border-t-2 border-fuchsia-200 dark:border-fuchsia-800' : ''}">
                                                ${idx === 0 ? `
                                                    <td rowspan="${examples.length}" class="text-center font-bold text-2xl text-fuchsia-600 dark:text-fuchsia-400 bg-slate-50 dark:bg-slate-800/50 align-middle">
                                                        <div class="flex flex-col items-center gap-2">
                                                            <span>${char}</span>
                                                            <button class="icon-btn" onclick="speakText('${char}')" title="Nghe k√Ω t·ª± n√†y">
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-1.414 1.414A6.472 6.472 0 0 1 12.026 8c0 1.966-.893 3.738-2.29 4.949l1.414 1.414z"/></svg>
                                                            </button>
                                                        </div>
                                                    </td>
                                                ` : ''}
                                                <td class="font-bold text-lg text-slate-800 dark:text-slate-200">${idx + 1}. ${ex.hanzi}</td>
                                                <td class="font-mono text-fuchsia-600 dark:text-fuchsia-400">${ex.pinyin}</td>
                                                <td>${ex.meaning}</td>
                                                <td class="text-center">
                                                    <button class="icon-btn" onclick="speakText('${ex.hanzi}')" title="Nghe t·ª´ n√†y">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-1.414 1.414A6.472 6.472 0 0 1 12.026 8c0 1.966-.893 3.738-2.29 4.949l1.414 1.414z"/></svg>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('');
                }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ` : ''}
                    ${memoryTipsSection}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${synonymsSection}
                        ${antonymsSection}
                    </div>
                    ${collocationsSection}
                    <div class="info-card">
                        <h3 class="card-title">‚ö†Ô∏è L∆∞u √Ω c√°ch d√πng</h3>
                        <p>${data.usage_notes}</p>
                    </div>
                `;
            },
            correction: (data, el, headerText) => {
                el.innerHTML = `
                    <h2 class="section-header">‚úçÔ∏è ${headerText}</h2>
                    <div class="info-card">
                        <p><strong>Pinyin g·ªëc:</strong> <span class="text-red-500 line-through font-mono">${data.original_pinyin}</span></p>
                        <p class="mt-2"><strong>Pinyin ƒë√£ s·ª≠a:</strong> <span class="text-green-600 font-semibold font-mono">${data.corrected_pinyin}</span></p>
                    </div>
                    <div class="info-card">
                        <h3 class="card-title">üîÑ C√°c thay ƒë·ªïi:</h3>
                        <ul class="list-disc list-inside">${data.changes.map(change => `<li>${change}</li>`).join('')}</ul>
                    </div>
                     <div class="info-card">
                        <h3 class="card-title">üáªüá≥ D·ªãch nghƒ©a:</h3>
                        <p><em>${data.translation}</em></p>
                    </div>`;
            },
            dialogue: (data, el, headerText) => {
                el.innerHTML = `
                    <h2 class="section-header flex justify-between items-center">
                        <span>üí¨ ${headerText}</span>
                        <button id="playFullDialogueBtn" class="primary-btn text-sm px-3 py-1.5" title="Ph√°t √¢m to√†n b·ªô ƒëo·∫°n h·ªôi tho·∫°i">
                             <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M10.804 8 5 4.633v6.734L10.804 8zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm15 0a7 7 0 1 0-14 0 7 7 0 0 0 14 0z"/></svg>
                             Ph√°t √¢m to√†n b·ªô
                        </button>
                    </h2>
                    <div class="flex flex-col gap-4 p-4 rounded-lg bg-slate-50 dark:bg-slate-900/50">
                    ${data.dialogue.map((line) => `
                        <div class="w-full flex ${line.character === data.characters[0] ? 'justify-start' : 'justify-end'}" data-hanzi="${line.hanzi.replace(/'/g, "\\'")}">
                            <div class="p-3 rounded-xl max-w-xl ${line.character === data.characters[0] ? 'bg-white dark:bg-slate-700 rounded-bl-none' : 'bg-fuchsia-50 dark:bg-fuchsia-950 rounded-br-none'} shadow-sm border border-black/5 dark:border-white/5">
                                <div class="flex items-start gap-3">
                                     <div class="flex-grow">
                                        <strong class="font-bold block ${line.character === data.characters[0] ? 'text-pink-600 dark:text-pink-400' : 'text-fuchsia-600 dark:text-fuchsia-400'}">${line.character}</strong>
                                        <p class="text-slate-800 dark:text-slate-200 mt-1 font-mono">${line.pinyin}</p>
                                    </div>
                                    <button class="icon-btn flex-shrink-0 -mt-1 -mr-1" onclick="speakText(this.closest('[data-hanzi]').dataset.hanzi)" title="Nghe c√¢u n√†y">
                                       <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-1.414 1.414A6.472 6.472 0 0 1 12.026 8c0 1.966-.893 3.738-2.29 4.949l1.414 1.414zM8.707 11.182A4.5 4.5 0 0 0 10.026 8a4.5 4.5 0 0 0-1.319-3.182L8.707 5.18a2.5 2.5 0 0 1 0 5.64l.001.002z"/></svg>
                                    </button>
                                </div>
                                <p class="text-sm text-slate-500 dark:text-slate-400 italic mt-2">(D·ªãch: ${line.vietnamese})</p>
                            </div>
                        </div>
                    `).join('')}
                    </div>`;

                document.getElementById('playFullDialogueBtn').addEventListener('click', () => {
                    const allHanziLines = Array.from(el.querySelectorAll('[data-hanzi]')).map(div => div.dataset.hanzi);
                    playFullDialogue(allHanziLines);
                });
            },
            summary: (data, el, headerText) => {
                el.innerHTML = `
                    <h2 class="section-header">üìã ${headerText}</h2>
                    <div class="info-card"><p class="leading-relaxed">${data.summary.replace(/\n/g, '<br>')}</p></div>`;
            },
            paragraphs: (data, el, headerText) => {
                el.innerHTML = `
                    <h2 class="section-header">üìÑ ${headerText}</h2>
                     <div class="info-card">
                        <h3 class="card-title-alt">üìù ƒêo·∫°n vƒÉn Pinyin:</h3>
                        <p class="font-mono leading-relaxed" data-hanzi="${data.hanzi_paragraph.replace(/"/g, '&quot;')}">${data.pinyin_paragraph}</p>
                        <button class="primary-btn mt-4" onclick="speakText(this.previousElementSibling.dataset.hanzi)">Nghe ƒëo·∫°n vƒÉn</button>
                    </div>
                    <div class="info-card">
                        <h3 class="card-title-alt">üìñ B·∫£n d·ªãch ti·∫øng Vi·ªát:</h3>
                        <p>${data.vietnamese_translation}</p>
                    </div>
                    <div class="info-card">
                        <h3 class="card-title-alt">üìñ B·∫£n d·ªãch h·ªón h·ª£p (Vi·ªát - Pinyin):</h3>
                        <p>${data.mixed_vietnamese_translation}</p>
                    </div>
                    <div class="info-card">
                        <h3 class="card-title-alt">üó£Ô∏è T·ª´ v·ª±ng ƒë√£ s·ª≠ d·ª•ng:</h3>
                        <div class="table-container">
                        <table>
                            <thead><tr><th>Pinyin</th><th>Nghƒ©a</th></tr></thead>
                            <tbody>
                                ${data.vocabulary_list.map(item => `<tr><td class="font-mono">${item.pinyin}</td><td>${item.meaning}</td></tr>`).join('')}
                            </tbody>
                        </table>
                        </div>
                    </div>`;
            },
            popularity: (data, el, headerText) => {
                const renderPopularityBadge = (status) => {
                    let colorClasses = "bg-gray-100 text-gray-800 dark:bg-gray-900/50 dark:text-gray-200";
                    if (status.includes("Ph·ªï bi·∫øn")) colorClasses = "bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-200";
                    if (status.includes("√çt")) colorClasses = "bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-200";
                    return `<span class="font-medium px-2 py-1 rounded-full ${colorClasses}">${status}</span>`;
                };

                el.innerHTML = `
                    <h2 class="section-header">üìä ${headerText}</h2>
                     <div class="table-container">
                    <table>
                        <thead><tr><th>T·ª´/C·ª•m t·ª´ (Pinyin)</th><th>M·ª©c ƒë·ªô</th><th>B·∫£n d·ªãch</th><th>Ng·ªØ c·∫£nh</th></tr></thead>
                        <tbody>
                            <tr>
                                <td class="font-bold text-lg text-fuchsia-600 dark:text-fuchsia-400 font-mono">${data.original_item.pinyin}</td>
                                <td>${renderPopularityBadge(data.original_item.popularity_status)}</td>
                                <td>${data.original_item.translation}</td>
                                <td>${data.original_item.context_explanation}</td>
                            </tr>
                            ${(data.suggested_alternatives && data.suggested_alternatives.length > 0) ? data.suggested_alternatives.map(alt => `
                                <tr>
                                    <td class="font-semibold font-mono">${alt.pinyin}</td>
                                    <td>${renderPopularityBadge(alt.popularity_status)}</td>
                                    <td>${alt.translation}</td>
                                    <td>${alt.context_explanation}</td>
                                </tr>`).join('') : `<tr><td colspan="4" class="text-center italic text-gray-500">Kh√¥ng c√≥ g·ª£i √Ω thay th·∫ø.</td></tr>`
                    }
                        </tbody>
                    </table>
                    </div>`;
            },
            reading: (data, el, headerText) => {
                el.innerHTML = `
                    <h2 class="section-header">üìñ ${headerText}</h2>
                    <div class="info-card">
                        <h3 class="card-title">üìù B√†i ƒë·ªçc (Pinyin)</h3>
                        <div class="prose max-w-none dark:text-gray-300 font-mono leading-relaxed" data-hanzi-passage="${data.reading_passage_hanzi.replace(/"/g, '&quot;')}">${data.reading_passage_pinyin.replace(/\n/g, '<br>')}</div>
                         <button class="primary-btn mt-4" onclick="speakText(this.previousElementSibling.dataset.hanziPassage)">Nghe b√†i ƒë·ªçc</button>
                    </div>
                    <h3 class="card-title mt-6">‚ùì C√¢u h·ªèi</h3>` +
                    data.questions.map(q => `
                    <div class="question-item" data-correct-answer="${q.correct_option_pinyin.replace(/"/g, '&quot;')}" data-question-translation="${q.question_text_vietnamese.replace(/"/g, '&quot;')}">
                        <p class="question-text">${q.id}. ${q.question_text_vietnamese}</p>
                        <div class="question-options">${q.options_pinyin.map(opt => `<button class="option-btn font-mono" onclick="checkMultipleChoiceAnswer(this)">${opt}</button>`).join('')}</div>
                        <div class="question-feedback"></div>
                    </div>`).join('');
            },
            listening: (data, el, headerText) => {
                el.innerHTML = `
                    <h2 class="section-header">üéß ${headerText}</h2>
                    <div class="info-card mb-4">
                        <div id="audioPlayerContainer"></div>
                        <div class="flex justify-center mt-4">
                           <button id="toggleTranscriptBtn" class="transcript-toggle-btn">üìú Hi·ªán vƒÉn b·∫£n</button>
                        </div>
                    </div>
                    <div id="transcriptContent" class="info-card hidden">
                        <h3 class="card-title">üìù VƒÉn b·∫£n b√†i nghe (Pinyin)</h3>
                        <div class="prose max-w-none dark:text-gray-300 p-2 font-mono">${data.audio_script_pinyin.replace(/\n/g, '<br>')}</div>
                        <h3 class="card-title-alt mt-4">üìñ B·∫£n d·ªãch</h3>
                        <div class="prose max-w-none dark:text-gray-400 p-2">${data.audio_script_translation.replace(/\n/g, '<br>')}</div >
                    </div>
                    <h3 class="card-title-alt mt-6">‚ùì C√¢u h·ªèi (B·∫±ng Ti·∫øng Vi·ªát)</h3>` +
                    data.questions.map(q => `
                    <div class="question-item" data-correct-answer="${q.correct_option_pinyin.replace(/"/g, '&quot;')}" data-question-translation="${q.question_text_vietnamese.replace(/"/g, '&quot;')}" >
                        <p class="question-text">${q.id}. ${q.question_text_vietnamese}</p>
                        <div class="question-options">${q.options_pinyin.map(opt => `<button class="option-btn font-mono" onclick="checkMultipleChoiceAnswer(this)">${opt}</button>`).join('')}</div>
                        <div class="question-feedback"></div>
                    </div>`).join('');

                setupAudioPlayer(data.audio_script_hanzi, document.getElementById('audioPlayerContainer'));

                const toggleBtn = document.getElementById('toggleTranscriptBtn');
                const transcriptContent = document.getElementById('transcriptContent');
                toggleBtn.addEventListener('click', () => {
                    const isHidden = transcriptContent.classList.toggle('hidden');
                    toggleBtn.innerHTML = isHidden ? 'üìú Hi·ªán vƒÉn b·∫£n' : 'üìú ·∫®n vƒÉn b·∫£n';
                });
            },
            conversationSimulator: async (scenario, el, headerText) => {
                el.innerHTML = `
                    <h2 class="section-header">üó£Ô∏è ${headerText}: ${scenario}</h2>
                    <div class="conversation-container">
                        <div class="message-area" id="messageArea"></div>
                        <div class="chat-input-container">
                            <input type="text" id="chatInput" class="chat-input" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi b·∫±ng Pinyin...">
                            <button id="chatSendButton" class="chat-send-btn">G·ª≠i</button>
                        </div>
                    </div>`;

                const chatInput = document.getElementById('chatInput');
                const chatSendButton = document.getElementById('chatSendButton');

                const handleSend = () => continueConversation();
                chatSendButton.addEventListener('click', handleSend);
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleSend();
                    }
                });

                const systemPrompt = `You are a helpful AI assistant named 'Linh', designed for Vietnamese learners of Chinese. Your task is to role-play a scenario in Chinese. The current scenario is: '${scenario}'. Start the conversation naturally in Chinese. Keep your responses friendly, encouraging, and not too long. Your entire response must be a single JSON object with these keys: "hanzi" (your response in Chinese characters), "pinyin" (the pinyin for your response), and "vietnamese" (the Vietnamese translation of your response).`;
                conversationHistory = [{ role: 'user', parts: [{ text: systemPrompt }] }];

                await getNextAiResponse();
            },
            comparison: (data, el, headerText) => {
                el.innerHTML = `
                    <h2 class="section-header">‚öñÔ∏è ${headerText}</h2>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Pinyin</th><th>Gi·∫£i th√≠ch</th><th>V√≠ d·ª• (Pinyin)</th><th>V√≠ d·ª• (Ti·∫øng Vi·ªát)</th><th>Ph√°t √¢m</th></tr></thead>
                            <tbody>
                            ${data.map(item => `
                                <tr data-hanzi-example="${item.example_hanzi.replace(/"/g, '&quot;')}">
                                    <td class="font-bold text-lg text-fuchsia-600 dark:text-fuchsia-400 font-mono">${item.pinyin}</td>
                                    <td>${item.explanation}</td>
                                    <td><em class="font-mono">"${item.example_pinyin}"</em></td>
                                    <td class="text-slate-600 dark:text-slate-300">${item.example_vietnamese || ''}</td>
                                    <td>
                                       <button class="icon-btn" onclick="speakText(this.closest('[data-hanzi-example]').dataset.hanziExample)" title="Nghe c√¢u n√†y">
                                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-1.414 1.414A6.472 6.472 0 0 1 12.026 8c0 1.966-.893 3.738-2.29 4.949l1.414 1.414z"/></svg>
                                       </button>
                                    </td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            },
            situationalSentences: (data, el, headerText) => {
                el.innerHTML = `<h2 class="section-header">üìß ${headerText}: ${data.situation}</h2>` +
                    data.sentences.map(sentence => `
                    <div class="info-card" data-hanzi="${sentence.hanzi.replace(/"/g, '&quot;')}">
                         <div class="flex items-start justify-between">
                            <div>
                                <p class="font-mono font-semibold text-lg">${sentence.pinyin}</p>
                                <p class="text-gray-600 dark:text-gray-400 italic mt-1">${sentence.vietnamese}</p>
                            </div>
                            <button class="audio-btn" style="width: 44px; height: 44px; min-width: 44px;" onclick="speakText(this.closest('[data-hanzi]').dataset.hanzi)" title="Nghe c√¢u n√†y">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-1.414 1.414A6.472 6.472 0 0 1 12.026 8c0 1.966-.893 3.738-2.29 4.949l1.414 1.414z"/></svg>
                            </button>
                         </div>
                    </div>
                `).join('');
            },
            toneAnalysis: (data, el, headerText) => {
                el.innerHTML = `
                    <h2 class="section-header">üé≠ ${headerText}</h2>
                    <div class="info-card">
                        <h3 class="card-title">C√¢u g·ªëc (Pinyin)</h3>
                        <p class="italic font-mono">"${data.original_pinyin}"</p>
                    </div>
                    <div class="info-card">
                        <h3 class="card-title">Ph√¢n t√≠ch thanh ƒëi·ªáu</h3>
                        <p>${data.explanation}</p>
                    </div>
                     <div class="info-card">
                        <h3 class="card-title">B·∫£ng thanh ƒëi·ªáu chi ti·∫øt</h3>
                        <div class="table-container">
                        <table>
                            <thead><tr><th>√Çm ti·∫øt</th><th>Thanh ƒëi·ªáu</th><th>K√Ω hi·ªáu</th><th>M√¥ t·∫£</th></tr></thead>
                            <tbody>
                            ${data.tones.map(t => `
                                <tr>
                                    <td class="font-mono">${t.syllable}</td>
                                    <td>Thanh ${t.tone_number}</td>
                                    <td>${t.mark}</td>
                                    <td>${t.description}</td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                        </div>
                     </div>
                `;
            },
            translationResults: (data, el, headerText) => {
                el.innerHTML = `
                    <h2 class="section-header">üîÅ ${headerText}</h2>
                     <div class="table-container">
                    <table>
                        <thead><tr><th>Ch·ªØ H√°n</th><th>Pinyin</th><th>M·ª©c ƒë·ªô ph·ªï bi·∫øn</th><th>Ghi ch√∫</th><th>Ph√°t √¢m</th></tr></thead>
                        <tbody>
                            ${data.map(item => `
                                <tr data-hanzi-item="${item.hanzi.replace(/"/g, '&quot;')}">
                                    <td class="font-semibold text-lg">${item.hanzi}</td>
                                    <td class="font-mono">${item.pinyin}</td>
                                    <td><span class="font-medium px-2 py-1 rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-200">${item.popularity_status}</span></td>
                                    <td>${item.usage_note}</td>
                                    <td>
                                        <button class="icon-btn" onclick="speakText(this.closest('[data-hanzi-item]').dataset.hanziItem)">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-1.414 1.414A6.472 6.472 0 0 1 12.026 8c0 1.966-.893 3.738-2.29 4.949l1.414 1.414z"/></svg>
                                        </button>
                                    </td>
                                </tr>`).join('')}
                        </tbody>
                    </table>
                    </div>`;
            },
            speakingPractice: async (topic, el, headerText) => {
                const { prompt, schema } = prompts.speakingPractice(topic);
                const data = await callGemini(prompt, schema);
                renderSpeakingPracticeUI(el, [data], topic, 'ai');
            },
            speakingPracticeManual: (input, el, headerText) => {
                // 'input' is the array of sentences from the modal
                const initialData = input.map(sentence => ({ vietnamese_sentence: sentence, hanzi_suggestion: '', pinyin_suggestion: '' }));
                renderSpeakingPracticeUI(el, initialData, '', 'manual');
            },
            pinyinPractice: async (topic, el, headerText) => {
                const { prompt, schema } = prompts.pinyinPractice(topic);
                const data = await callGemini(prompt, schema);
                renderPinyinPracticeUI(el, data, topic);
            },
        };

        function highlightPinyinDifferences(target, typed) {
            // Simple word-by-word comparison for Pinyin
            const targetWords = target.toLowerCase().split(/\s+/).filter(w => w);
            const typedWords = typed.toLowerCase().split(/\s+/).filter(w => w);
            let highlightedTyped = [];
            for (let i = 0; i < Math.max(targetWords.length, typedWords.length); i++) {
                if (typedWords[i] === undefined) break;
                if (targetWords[i] === typedWords[i]) {
                    highlightedTyped.push(typedWords[i]);
                } else {
                    highlightedTyped.push(`<span class="bg-red-200 text-red-700 px-1 rounded">${typedWords[i] || ''}</span>`);
                }
            }
            return highlightedTyped.join(' ');
        }

        function renderSpeakingPracticeUI(el, initialSentences, topic, mode) {
            let sentences = initialSentences;
            let currentIndex = 0;
            let currentData = sentences[currentIndex];

            el.innerHTML = `
                <h2 class="section-header">üéôÔ∏è Luy·ªán ph·∫£n x·∫° n√≥i ${mode === 'manual' ? '(Th·ªß c√¥ng)' : '(AI)'}</h2>
                <div id="speaking-practice-card" class="info-card text-center relative speaking-practice-card">
                    <p class="text-2xl font-bold" id="vietnamese-sentence-display"></p>
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2" id="speaking-practice-loader" style="display:none;">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
                <div class="flex justify-center items-center gap-4 mt-4 practice-actions">
                    <button id="new-sentence-btn" class="feature-btn">üîÑ C√¢u kh√°c</button>
                    <button id="show-answer-btn" class="primary-btn">üí° Hi·ªán ƒë√°p √°n</button>
                    <button id="record-pronunciation-btn" class="pronunciation-record-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z"/><path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/></svg>
                        <span>Ghi √¢m & Ch·∫•m ƒëi·ªÉm</span>
                    </button>
                </div>
                <div id="answer-container" class="mt-6 hidden"></div>
                <div id="pronunciation-score-container" class="mt-6 hidden"></div>
            `;

            const sentenceDisplay = document.getElementById('vietnamese-sentence-display');
            const answerContainer = document.getElementById('answer-container');
            const newSentenceBtn = document.getElementById('new-sentence-btn');
            const showAnswerBtn = document.getElementById('show-answer-btn');
            const recordBtn = document.getElementById('record-pronunciation-btn');
            const scoreContainer = document.getElementById('pronunciation-score-container');
            const loader = document.getElementById('speaking-practice-loader');

            const fetchAndSetSuggestions = async (vietnameseSentence) => {
                try {
                    showAnswerBtn.disabled = true;
                    showAnswerBtn.innerHTML = `<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>`;
                    const { prompt, schema } = prompts.speakingPractice(vietnameseSentence);
                    const suggestionData = await callGemini(prompt, schema);
                    currentData = suggestionData; // Update currentData with new suggestions

                    answerContainer.innerHTML = `
                        <div class="info-card">
                           <h3 class="card-title">G·ª£i √Ω tr·∫£ l·ªùi</h3>
                           <p class="font-mono text-lg font-semibold">${currentData.pinyin_suggestion}</p>
                           <button class="icon-btn mt-2" onclick="speakText('${currentData.hanzi_suggestion.replace(/'/g, "\\'")}')">Nghe ƒë√°p √°n</button>
                        </div>
                    `;
                    answerContainer.classList.remove('hidden');
                    showAnswerBtn.textContent = 'üôà ·∫®n ƒë√°p √°n';
                } catch (e) {
                    answerContainer.innerHTML = `<p class="text-red-500">Kh√¥ng th·ªÉ t·∫£i g·ª£i √Ω.</p>`;
                    showAnswerBtn.textContent = 'üí° Hi·ªán ƒë√°p √°n';
                } finally {
                    showAnswerBtn.disabled = false;
                }
            };

            const displaySentence = (data) => {
                currentData = data;
                sentenceDisplay.textContent = data.vietnamese_sentence;
                answerContainer.innerHTML = '';
                answerContainer.classList.add('hidden');
                scoreContainer.innerHTML = '';
                scoreContainer.classList.add('hidden');
                showAnswerBtn.textContent = 'üí° Hi·ªán ƒë√°p √°n';
                showAnswerBtn.disabled = false;
            };

            const showNextSentence = async () => {
                newSentenceBtn.disabled = true;
                loader.style.display = 'block';
                sentenceDisplay.style.opacity = '0.3';

                if (mode === 'ai') {
                    const { prompt, schema } = prompts.speakingPractice(topic);
                    const data = await callGemini(prompt, schema);
                    sentences = [data];
                    currentIndex = 0;
                    displaySentence(data);
                } else {
                    currentIndex = (currentIndex + 1) % sentences.length;
                    displaySentence(sentences[currentIndex]);
                }

                loader.style.display = 'none';
                sentenceDisplay.style.opacity = '1';
                newSentenceBtn.disabled = false;
            };

            showAnswerBtn.addEventListener('click', () => {
                if (answerContainer.classList.contains('hidden')) {
                    if (currentData.pinyin_suggestion) { // If we already have the answer
                        answerContainer.innerHTML = `
                            <div class="info-card">
                               <h3 class="card-title">G·ª£i √Ω tr·∫£ l·ªùi</h3>
                               <p class="font-mono text-lg font-semibold">${currentData.pinyin_suggestion}</p>
                               <button class="icon-btn mt-2" onclick="speakText('${currentData.hanzi_suggestion.replace(/'/g, "\\'")}')">Nghe ƒë√°p √°n</button>
                            </div>
                         `;
                        answerContainer.classList.remove('hidden');
                        showAnswerBtn.textContent = 'üôà ·∫®n ƒë√°p √°n';
                    } else { // Fetch it if not
                        fetchAndSetSuggestions(currentData.vietnamese_sentence);
                    }
                } else {
                    answerContainer.classList.add('hidden');
                    showAnswerBtn.textContent = 'üí° Hi·ªán ƒë√°p √°n';
                }
            });

            recordBtn.addEventListener('click', () => {
                if (isRecording) {
                    if (recognition) recognition.stop();
                } else {
                    handlePronunciationRecording(currentData);
                }
            });

            newSentenceBtn.addEventListener('click', showNextSentence);
            displaySentence(currentData); // Initial display
        }

        function renderPinyinPracticeUI(el, initialData, topic) {
            let currentData = initialData;

            el.innerHTML = `
                <h2 class="section-header">‚úçÔ∏è Luy·ªán g√µ Pinyin (AI)</h2>
                <div class="info-card">
                    <h3 class="card-title">D·ªãch c√¢u sau v√† g√µ Pinyin (c√≥ d·∫•u ho·∫∑c kh√¥ng):</h3>
                    <p id="vietnamese-writing-prompt" class="text-xl font-semibold text-center py-4">${currentData.vietnamese_sentence}</p>
                </div>
                <textarea id="pinyin-writing-input" class="textarea-input font-mono" placeholder="V√≠ d·ª•: wo3 ai4 ni3 ho·∫∑c w«í √†i n«ê..."></textarea>
                <div id="writing-feedback-container" class="mt-4"></div>
                <div class="flex justify-center gap-4 mt-4 practice-actions">
                     <button id="check-writing-btn" class="primary-btn">‚úîÔ∏è Ki·ªÉm tra</button>
                     <button id="hint-writing-btn" class="feature-btn">üí° G·ª£i √Ω</button>
                     <button id="next-writing-btn" class="feature-btn">üîÑ C√¢u kh√°c</button>
                </div>
            `;

            const promptDisplay = document.getElementById('vietnamese-writing-prompt');
            const inputArea = document.getElementById('pinyin-writing-input');
            const feedbackContainer = document.getElementById('writing-feedback-container');
            const checkBtn = document.getElementById('check-writing-btn');
            const hintBtn = document.getElementById('hint-writing-btn');
            const nextBtn = document.getElementById('next-writing-btn');

            const fetchNewSentence = async () => {
                feedbackContainer.innerHTML = '';
                inputArea.value = '';
                promptDisplay.textContent = 'ƒêang t·∫£i c√¢u m·ªõi...';
                const { prompt, schema } = prompts.pinyinPractice(topic);
                currentData = await callGemini(prompt, schema);
                promptDisplay.textContent = currentData.vietnamese_sentence;
                checkBtn.disabled = false;
                hintBtn.disabled = false;
            };

            hintBtn.addEventListener('click', () => {
                feedbackContainer.innerHTML = `
                    <div class="info-card">
                       <h3 class="card-title">G·ª£i √Ω ƒë√°p √°n</h3>
                       <p class="font-mono text-lg font-semibold">${currentData.pinyin_suggestion}</p>
                       <button class="icon-btn mt-2" onclick="speakText('${currentData.hanzi_suggestion.replace(/'/g, "\\'")}')">Nghe ƒë√°p √°n</button>
                    </div>`;
            });

            checkBtn.addEventListener('click', async () => {
                const userPinyin = inputArea.value.trim();
                if (!userPinyin) {
                    showMessage("Vui l√≤ng nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n.", 'error');
                    return;
                }

                checkBtn.disabled = true;
                hintBtn.disabled = true;
                feedbackContainer.innerHTML = '<p class="text-center font-semibold">ƒêang ki·ªÉm tra...</p>';

                const { prompt, schema } = prompts.checkPinyin(currentData.vietnamese_sentence, userPinyin, currentData.pinyin_suggestion);
                const result = await callGemini(prompt, schema);

                let resultHTML;
                if (result.is_correct) {
                    resultHTML = `
                        <div class="info-card border-green-500 bg-green-50 dark:bg-green-900/50 dark:border-green-700">
                            <h3 class="card-title text-green-700 dark:text-green-300">üéâ Ch√≠nh x√°c!</h3>
                            <p><strong>ƒê√°p √°n ƒë√∫ng:</strong> <span class="font-mono">${result.corrected_pinyin}</span></p>
                            <div class="flex justify-center mt-4"><button onclick="document.getElementById('next-writing-btn').click()" class="feature-btn">Ti·∫øp t·ª•c</button></div>
                        </div>
                    `;
                } else {
                    const highlightedText = highlightPinyinDifferences(result.corrected_pinyin, userPinyin);
                    resultHTML = `
                         <div class="info-card border-red-500 bg-red-50 dark:bg-red-900/50 dark:border-red-700">
                            <h3 class="card-title text-red-700 dark:text-red-300">ü§î C·∫ßn xem l·∫°i!</h3>
                            <p><strong>C√¢u c·ªßa b·∫°n:</strong> <span class="font-mono">${highlightedText}</span></p>
                            <p class="mt-2"><strong>ƒê√°p √°n ƒë√∫ng:</strong> <span class="font-semibold text-green-600 dark:text-green-400 font-mono">${result.corrected_pinyin}</span></p>
                            <h4 class="card-title-alt mt-4">Ghi ch√∫:</h4>
                            <p>${result.feedback}</p>
                            <div class="flex justify-center mt-4"><button onclick="document.getElementById('next-writing-btn').click()" class="feature-btn">Ti·∫øp t·ª•c</button></div>
                        </div>`;
                }
                feedbackContainer.innerHTML = resultHTML;
            });

            nextBtn.addEventListener('click', fetchNewSentence);
        }

        // --- PROMPTS (Chinese Version) ---
        const prompts = {
            quickLookup: (input) => ({
                prompt: `Cho t·ª´/c√¢u ti·∫øng Vi·ªát sau: "${input}", h√£y cung c·∫•p b·∫£n d·ªãch ti·∫øng Trung t∆∞∆°ng ·ª©ng. Tr·∫£ v·ªÅ m·ªôt ƒë·ªëi t∆∞·ª£ng JSON duy nh·∫•t c√≥ c√°c kh√≥a: "hanzi" (ch·ªØ H√°n), "pinyin" (pinyin c√≥ d·∫•u), v√† "meaning" (nghƒ©a ti·∫øng Vi·ªát, c√≥ th·ªÉ gi·ªëng v·ªõi input n·∫øu input l√† ti·∫øng Vi·ªát). N·∫øu input l√† Pinyin, h√£y t√¨m ch·ªØ H√°n v√† nghƒ©a ti·∫øng Vi·ªát t∆∞∆°ng ·ª©ng.`,
                schema: { type: "OBJECT", properties: { hanzi: { type: "STRING" }, pinyin: { type: "STRING" }, meaning: { type: "STRING" } }, required: ["hanzi", "pinyin", "meaning"] }
            }),
            pronunciationScore: (targetHanzi, spokenText) => ({
                prompt: `ƒê√°nh gi√° kh·∫£ nƒÉng ph√°t √¢m ti·∫øng Trung. VƒÉn b·∫£n n√≥i ƒë∆∞·ª£c (c√≥ th·ªÉ kh√¥ng ch√≠nh x√°c) l√†: "${spokenText}". C√¢u ƒë√∫ng ph·∫£i l√†: "${targetHanzi}". H√£y so s√°nh v√† cho ƒëi·ªÉm t∆∞∆°ng ƒë·ªìng t·ª´ 0-100. Cung c·∫•p nh·∫≠n x√©t ng·∫Øn g·ªçn b·∫±ng ti·∫øng Vi·ªát. Tr·∫£ v·ªÅ JSON c√≥ kh√≥a "score" (s·ªë) v√† "feedback" (chu·ªói).`,
                schema: { type: "OBJECT", properties: { score: { type: "NUMBER" }, feedback: { type: "STRING" } }, required: ["score", "feedback"] }
            }),
            convertToPinyin: (hanzi) => ({
                prompt: `Chuy·ªÉn ƒë·ªïi c√°c k√Ω t·ª± ti·∫øng Trung sau ƒë√¢y sang Pinyin c√≥ d·∫•u: "${hanzi}". Tr·∫£ v·ªÅ m·ªôt ƒë·ªëi t∆∞·ª£ng JSON c√≥ kh√≥a duy nh·∫•t "pinyin".`,
                schema: { type: "OBJECT", properties: { pinyin: { type: "STRING" } }, required: ["pinyin"] }
            }),
            examples: (input) => ({ prompt: `T·∫°o 15 c√¢u v√≠ d·ª• ti·∫øng Trung cho t·ª´ ho·∫∑c ch·ªß ƒë·ªÅ "${input}". V·ªõi m·ªói c√¢u, tr·∫£ v·ªÅ d∆∞·ªõi d·∫°ng ƒë·ªëi t∆∞·ª£ng JSON c√≥ c√°c kh√≥a: "hanzi" (c√¢u b·∫±ng ch·ªØ H√°n), "pinyin" (pinyin c√≥ d·∫•u), "vietnamese" (b·∫£n d·ªãch ti·∫øng Vi·ªát). To√†n b·ªô k·∫øt qu·∫£ l√† m·ªôt m·∫£ng JSON c√°c ƒë·ªëi t∆∞·ª£ng n√†y.`, schema: { type: "ARRAY", items: { type: "OBJECT", properties: { hanzi: { type: "STRING" }, pinyin: { type: "STRING" }, vietnamese: { type: "STRING" } }, required: ["hanzi", "pinyin", "vietnamese"] } } }),
            exercise: (input) => ({ prompt: `T·∫°o 10 c√¢u b√†i t·∫≠p ƒëi·ªÅn v√†o ch·ªó tr·ªëng cho t·ª´/ch·ªß ƒë·ªÅ ti·∫øng Trung "${input}". M·ªói c√¢u, cung c·∫•p: c√¢u ti·∫øng H√°n ƒë·∫ßy ƒë·ªß, c√¢u pinyin v·ªõi m·ªôt t·ª´ b·ªã thi·∫øu thay b·∫±ng "____", pinyin c·ªßa t·ª´ ƒë√∫ng, 4 l·ª±a ch·ªçn pinyin ng·∫´u nhi√™n (bao g·ªìm ƒë√°p √°n ƒë√∫ng), v√† b·∫£n d·ªãch ti·∫øng Vi·ªát. Tr·∫£ v·ªÅ m·∫£ng JSON v·ªõi c√°c thu·ªôc t√≠nh: "id", "hanzi_sentence", "pinyin_with_blank", "correct_word_pinyin", "options", "translation".`, schema: { type: "ARRAY", items: { type: "OBJECT", properties: { id: { type: "NUMBER" }, hanzi_sentence: { type: "STRING" }, pinyin_with_blank: { type: "STRING" }, correct_word_pinyin: { type: "STRING" }, options: { type: "ARRAY", items: { type: "STRING" } }, translation: { type: "STRING" } }, required: ["id", "hanzi_sentence", "pinyin_with_blank", "correct_word_pinyin", "options", "translation"] } } }),
            listeningFillInTheBlank: (input) => ({ prompt: `T·∫°o 10 c√¢u b√†i t·∫≠p nghe v√† ƒëi·ªÅn t·ª´ ti·∫øng Trung cho ch·ªß ƒë·ªÅ "${input}". M·ªói c√¢u c√≥: c√¢u ti·∫øng H√°n ƒë·∫ßy ƒë·ªß ƒë·ªÉ ph√°t √¢m, c√¢u pinyin v·ªõi m·ªôt t·ª´ b·ªã thi·∫øu thay b·∫±ng "____", pinyin c·ªßa t·ª´ ƒë√∫ng, 4 l·ª±a ch·ªçn pinyin (bao g·ªìm ƒë√°p √°n ƒë√∫ng), v√† b·∫£n d·ªãch ti·∫øng Vi·ªát. Tr·∫£ v·ªÅ m·∫£ng JSON v·ªõi thu·ªôc t√≠nh: "id", "hanzi_sentence", "pinyin_with_blank", "correct_word_pinyin", "options", "translation".`, schema: { type: "ARRAY", items: { type: "OBJECT", properties: { id: { type: "NUMBER" }, hanzi_sentence: { type: "STRING" }, pinyin_with_blank: { type: "STRING" }, correct_word_pinyin: { type: "STRING" }, options: { type: "ARRAY", items: { type: "STRING" } }, translation: { type: "STRING" } }, required: ["id", "hanzi_sentence", "pinyin_with_blank", "correct_word_pinyin", "options", "translation"] } } }),
            explanation: (input) => ({
                prompt: `Gi·∫£i th√≠ch t·ª´ v·ª±ng ho·∫∑c ng·ªØ ph√°p ti·∫øng Trung cho "${input}". B·∫ÆT BU·ªòC ph·∫£i tr·∫£ v·ªÅ JSON v·ªõi T·∫§T C·∫¢ c√°c kh√≥a sau (kh√¥ng ƒë∆∞·ª£c thi·∫øu b·∫•t k·ª≥ kh√≥a n√†o):

1. 'explanation': Gi·∫£i th√≠ch chung b·∫±ng ti·∫øng Vi·ªát (t·ªëi ƒëa 2 c√¢u), n·∫øu ng∆∞·ªùi d√πng nh·∫≠p ti·∫øng vi·ªát th√¨ d·ªãch sang ti·∫øng trung v√† bao g·ªìm c·∫£ piyin
2. 'components': M·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng cho m·ªói k√Ω t·ª±, m·ªói ƒë·ªëi t∆∞·ª£ng c√≥ 'pinyin', 'hanzi', v√† 'meaning' (nghƒ©a g·ªëc)
3. 'component_examples': M·ªôt ƒë·ªëi t∆∞·ª£ng ch·ª©a danh s√°ch v√≠ d·ª• cho t·ª´ng k√Ω t·ª± trong components. M·ªói kh√≥a l√† ch·ªØ H√°n c·ªßa k√Ω t·ª± ƒë√≥, v√† gi√° tr·ªã l√† m·ªôt m·∫£ng 5 ƒë·ªëi t∆∞·ª£ng v√≠ d·ª•. M·ªói v√≠ d·ª• c√≥: 'hanzi' (t·ª´ v·ª±ng v√≠ d·ª•), 'pinyin' (pinyin c√≥ d·∫•u), 'hanviet' (√¢m H√°n Vi·ªát), 'meaning' (nghƒ©a ti·∫øng Vi·ªát).
4. 'usage_notes': L∆∞u √Ω c√°ch d√πng b·∫±ng ti·∫øng Vi·ªát (t·ªëi ƒëa 2 c√¢u)
5. 'memory_tips': M·∫£ng c√°c m·∫πo ƒë·ªÉ d·ªÖ nh·ªõ b·∫±ng ti·∫øng Vi·ªát (m·ªói m·∫πo l√† m·ªôt chu·ªói ng·∫Øn g·ªçn)
6. 'synonyms': M·∫£ng c√°c t·ª´ ƒë·ªìng nghƒ©a (√≠t nh·∫•t 2-3 t·ª´), m·ªói ƒë·ªëi t∆∞·ª£ng c√≥ 'pinyin', 'hanzi', 'meaning' (nghƒ©a ti·∫øng Vi·ªát), v√† 'rating' (s·ªë t·ª´ 1 ƒë·∫øn 5)
7. 'antonyms': M·∫£ng c√°c t·ª´ tr√°i nghƒ©a (√≠t nh·∫•t 1-2 t·ª´ n·∫øu c√≥, n·∫øu kh√¥ng c√≥ t·ª´ tr√°i nghƒ©a ph√π h·ª£p th√¨ tr·∫£ v·ªÅ m·∫£ng r·ªóng []), m·ªói ƒë·ªëi t∆∞·ª£ng c√≥ 'pinyin', 'hanzi', 'meaning' (nghƒ©a ti·∫øng Vi·ªát), v√† 'rating' (s·ªë t·ª´ 1 ƒë·∫øn 5)
8. 'collocations': M·∫£ng c√°c c·ª•m t·ª´ ph·ªï bi·∫øn th∆∞·ªùng ƒëi chung v·ªõi t·ª´ n√†y (√≠t nh·∫•t 3-5 c·ª•m t·ª´), s·∫Øp x·∫øp theo ƒë·ªô ph·ªï bi·∫øn t·ª´ cao xu·ªëng th·∫•p, m·ªói ƒë·ªëi t∆∞·ª£ng c√≥ 'pinyin', 'hanzi', 'meaning' (nghƒ©a ti·∫øng Vi·ªát), v√† 'rating' (s·ªë t·ª´ 1 ƒë·∫øn 5)

QUAN TR·ªåNG: Ph·∫£i lu√¥n tr·∫£ v·ªÅ T·∫§T C·∫¢ c√°c kh√≥a tr√™n, k·ªÉ c·∫£ khi m·ªôt s·ªë m·∫£ng c√≥ th·ªÉ r·ªóng. Gi·ªØ c√°c chu·ªói ng·∫Øn g·ªçn v√† ƒë·∫£m b·∫£o JSON h·ª£p l·ªá.`,
                schema: { type: "OBJECT", properties: { explanation: { "type": "STRING" }, components: { type: "ARRAY", items: { type: "OBJECT", properties: { pinyin: { "type": "STRING" }, hanzi: { "type": "STRING" }, meaning: { "type": "STRING" } }, required: ["pinyin", "hanzi", "meaning"] } }, component_examples: { type: "OBJECT" }, usage_notes: { "type": "STRING" }, memory_tips: { type: "ARRAY", items: { type: "STRING" } }, synonyms: { type: "ARRAY", items: { type: "OBJECT", properties: { pinyin: { "type": "STRING" }, hanzi: { "type": "STRING" }, meaning: { "type": "STRING" }, rating: { "type": "NUMBER" } }, required: ["pinyin", "hanzi", "meaning", "rating"] } }, antonyms: { type: "ARRAY", items: { type: "OBJECT", properties: { pinyin: { "type": "STRING" }, hanzi: { "type": "STRING" }, meaning: { "type": "STRING" }, rating: { "type": "NUMBER" } }, required: ["pinyin", "hanzi", "meaning", "rating"] } }, collocations: { type: "ARRAY", items: { type: "OBJECT", properties: { pinyin: { "type": "STRING" }, hanzi: { "type": "STRING" }, meaning: { "type": "STRING" }, rating: { "type": "NUMBER" } }, required: ["pinyin", "hanzi", "meaning", "rating"] } } }, required: ["explanation", "components", "component_examples", "usage_notes", "synonyms", "antonyms", "collocations", "memory_tips"] }
            }),
            correction: (input) => ({ prompt: `S·ª≠a l·ªói c√¢u Pinyin sau: "${input}". H√£y ƒëo√°n ch·ªØ H√°n t∆∞∆°ng ·ª©ng, ki·ªÉm tra ng·ªØ ph√°p, sau ƒë√≥ cung c·∫•p pinyin g·ªëc, pinyin ƒë√£ s·ª≠a, danh s√°ch c√°c thay ƒë·ªïi (gi·∫£i th√≠ch b·∫±ng TI·∫æNG VI·ªÜT), v√† b·∫£n d·ªãch ti·∫øng Vi·ªát c·ªßa c√¢u ƒë√£ s·ª≠a. Tr·∫£ v·ªÅ JSON v·ªõi kh√≥a: "original_pinyin", "corrected_pinyin", "changes" (m·∫£ng chu·ªói), "translation".`, schema: { type: "OBJECT", properties: { original_pinyin: { type: "STRING" }, corrected_pinyin: { type: "STRING" }, changes: { type: "ARRAY", items: { type: "STRING" } }, translation: { type: "STRING" } }, required: ["original_pinyin", "corrected_pinyin", "changes", "translation"] } }),
            dialogue: (input) => ({ prompt: `T·∫°o ƒëo·∫°n h·ªôi tho·∫°i ti·∫øng Trung v·ªÅ ch·ªß ƒë·ªÅ "${input}" gi·ªØa hai nh√¢n v·∫≠t (v√≠ d·ª•: A v√† B). Cung c·∫•p t√™n nh√¢n v·∫≠t, l·ªùi tho·∫°i ch·ªØ H√°n, pinyin v√† b·∫£n d·ªãch ti·∫øng Vi·ªát cho m·ªói d√≤ng. Tr·∫£ v·ªÅ JSON c√≥ kh√≥a: "characters" (m·∫£ng 2 t√™n), "dialogue" (m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng c√≥ kh√≥a "character", "hanzi", "pinyin", "vietnamese").`, schema: { type: "OBJECT", properties: { characters: { type: "ARRAY", items: { type: "STRING" } }, dialogue: { type: "ARRAY", items: { type: "OBJECT", properties: { character: { type: "STRING" }, hanzi: { type: "STRING" }, pinyin: { type: "STRING" }, vietnamese: { type: "STRING" } }, required: ["character", "hanzi", "pinyin", "vietnamese"] } } }, required: ["characters", "dialogue"] } }),
            summary: (input) => ({ prompt: `T√≥m t·∫Øt vƒÉn b·∫£n Pinyin sau ƒë√¢y sang ti·∫øng Vi·ªát ng·∫Øn g·ªçn: "${input}". Tr·∫£ v·ªÅ JSON c√≥ kh√≥a "summary".`, schema: { type: "OBJECT", properties: { summary: { type: "STRING" } }, required: ["summary"] } }),
            paragraphs: (input) => ({
                prompt: `S·ª≠ d·ª•ng c√°c t·ª´ v·ª±ng ti·∫øng Vi·ªát sau: "${input}", h√£y: 1. D·ªãch ch√∫ng sang ti·∫øng Trung (Pinyin v√† H√°n t·ª±). 2. Vi·∫øt m·ªôt ƒëo·∫°n vƒÉn v·ªõi ƒë·∫ßy ƒë·ªß c√°c t·ª´ kh√≥a cung c·∫•p ( √≠t nh·∫•t 300 t·ª´ tr·ªü l√™n) b·∫±ng ch·ªØ H√°n s·ª≠ d·ª•ng t·∫•t c·∫£ c√°c t·ª´ ƒë√≥. 3. Cung c·∫•p Pinyin cho ƒëo·∫°n vƒÉn, trong ƒë√≥ b√¥i ƒë·∫≠m (d√πng th·∫ª <b>) c√°c t·ª´ kh√≥a ƒë√£ cho. 4. D·ªãch to√†n b·ªô ƒëo·∫°n vƒÉn sang ti·∫øng Vi·ªát. 5. T·∫°o m·ªôt phi√™n b·∫£n d·ªãch "h·ªón h·ª£p": l·∫•y b·∫£n d·ªãch ti·∫øng Vi·ªát ·ªü b∆∞·ªõc 4, nh∆∞ng thay th·∫ø c√°c t·ª´ ƒë√£ d·ªãch b·∫±ng T·ª™ V·ª∞NG G·ªêC (Pinyin) ƒë∆∞·ª£c t√¥ ƒë·∫≠m. 6. Li·ªát k√™ l·∫°i t·ª´ v·ª±ng ƒë√£ d√πng (pinyin v√† nghƒ©a). Tr·∫£ v·ªÅ JSON c√≥ kh√≥a: "pinyin_paragraph", "hanzi_paragraph", "vietnamese_translation", "mixed_vietnamese_translation", "vocabulary_list".`,
                schema: { type: "OBJECT", properties: { pinyin_paragraph: { type: "STRING" }, hanzi_paragraph: { type: "STRING" }, vietnamese_translation: { type: "STRING" }, mixed_vietnamese_translation: { type: "STRING" }, vocabulary_list: { type: "ARRAY", items: { type: "OBJECT", properties: { pinyin: { type: "STRING" }, meaning: { type: "STRING" } }, required: ["pinyin", "meaning"] } } }, required: ["pinyin_paragraph", "hanzi_paragraph", "vietnamese_translation", "mixed_vietnamese_translation", "vocabulary_list"] }
            }),
            popularity: (input) => ({ prompt: `Ph√¢n t√≠ch ƒë·ªô ph·ªï bi·∫øn c·ªßa t·ª´ Pinyin "${input}". Cung c·∫•p tr·∫°ng th√°i ("R·∫•t ph·ªï bi·∫øn", "Ph·ªï bi·∫øn", "√çt ph·ªï bi·∫øn"), b·∫£n d·ªãch, ng·ªØ c·∫£nh. N·∫øu kh√¥ng ph·ªï bi·∫øn, ƒë·ªÅ xu·∫•t 1-2 ph∆∞∆°ng √°n thay th·∫ø. Tr·∫£ v·ªÅ JSON c√≥ kh√≥a: "original_item" (ƒë·ªëi t∆∞·ª£ng c√≥ 'pinyin', 'popularity_status', 'translation', 'context_explanation'), v√† "suggested_alternatives" (m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng t∆∞∆°ng t·ª±).`, schema: { type: "OBJECT", properties: { original_item: { type: "OBJECT", properties: { pinyin: { type: "STRING" }, popularity_status: { type: "STRING" }, translation: { type: "STRING" }, context_explanation: { type: "STRING" } } }, suggested_alternatives: { type: "ARRAY", items: { type: "OBJECT", properties: { pinyin: { type: "STRING" }, popularity_status: { type: "STRING" }, translation: { type: "STRING" }, context_explanation: { type: "STRING" } } } } }, required: ["original_item"] } }),
            reading: (input) => ({ prompt: `T·∫°o b√†i ƒë·ªçc hi·ªÉu ti·∫øng Trung (kho·∫£ng 100 ch·ªØ H√°n) v·ªÅ ch·ªß ƒë·ªÅ "${input}". T·∫°o 3 c√¢u h·ªèi tr·∫Øc nghi·ªám b·∫±ng Ti·∫øng Vi·ªát. M·ªói c√¢u h·ªèi c√≥ 3 l·ª±a ch·ªçn b·∫±ng Pinyin. Tr·∫£ v·ªÅ JSON: "reading_passage_hanzi", "reading_passage_pinyin", "questions" (m·∫£ng, m·ªói ƒë·ªëi t∆∞·ª£ng ch·ª©a: "id", "question_text_vietnamese", "options_pinyin" (m·∫£ng 3 chu·ªói), "correct_option_pinyin").`, schema: { type: "OBJECT", properties: { reading_passage_hanzi: { type: "STRING" }, reading_passage_pinyin: { type: "STRING" }, questions: { type: "ARRAY", items: { type: "OBJECT", properties: { id: { type: "NUMBER" }, question_text_vietnamese: { type: "STRING" }, options_pinyin: { type: "ARRAY", items: { type: "STRING" } }, correct_option_pinyin: { type: "STRING" } }, required: ["id", "question_text_vietnamese", "options_pinyin", "correct_option_pinyin"] } } }, required: ["reading_passage_hanzi", "reading_passage_pinyin", "questions"] } }),
            listening: (input) => ({ prompt: `T·∫°o k·ªãch b·∫£n nghe ti·∫øng Trung (kho·∫£ng 80 ch·ªØ H√°n) v·ªÅ ch·ªß ƒë·ªÅ "${input}". D·ªãch k·ªãch b·∫£n sang ti·∫øng Vi·ªát. T·∫°o 3 c√¢u h·ªèi tr·∫Øc nghi·ªám b·∫±ng Ti·∫øng Vi·ªát d·ª±a tr√™n n·ªôi dung. M·ªói c√¢u c√≥ 3 l·ª±a ch·ªçn b·∫±ng Pinyin. Tr·∫£ v·ªÅ JSON: "audio_script_hanzi", "audio_script_pinyin", "audio_script_translation", "questions" (m·∫£ng, m·ªói ƒë·ªëi t∆∞·ª£ng ch·ª©a: "id", "question_text_vietnamese", "options_pinyin", "correct_option_pinyin").`, schema: { type: "OBJECT", properties: { audio_script_hanzi: { type: "STRING" }, audio_script_pinyin: { type: "STRING" }, audio_script_translation: { type: "STRING" }, questions: { type: "ARRAY", items: { type: "OBJECT", properties: { id: { type: "NUMBER" }, question_text_vietnamese: { type: "STRING" }, options_pinyin: { type: "ARRAY", items: { type: "STRING" } }, correct_option_pinyin: { type: "STRING" } }, required: ["id", "question_text_vietnamese", "options_pinyin", "correct_option_pinyin"] } } }, required: ["audio_script_hanzi", "audio_script_pinyin", "audio_script_translation", "questions"] } }),
            speakingPractice: (input) => ({ prompt: `D·ª±a v√†o ch·ªß ƒë·ªÅ ho·∫∑c c√¢u ti·∫øng Vi·ªát "${input}", h√£y t·∫°o m·ªôt c√¢u ti·∫øng Vi·ªát t∆∞∆°ng ƒë∆∞∆°ng ho·∫∑c li√™n quan ƒë·ªÉ ng∆∞·ªùi d√πng d·ªãch v√† n√≥i b·∫±ng ti·∫øng Trung. Sau ƒë√≥, cung c·∫•p b·∫£n d·ªãch ti·∫øng Trung g·ª£i √Ω cho c√¢u ƒë√≥. Tr·∫£ v·ªÅ m·ªôt ƒë·ªëi t∆∞·ª£ng JSON v·ªõi c√°c kh√≥a: "vietnamese_sentence", "hanzi_suggestion", v√† "pinyin_suggestion".`, schema: { type: "OBJECT", properties: { vietnamese_sentence: { type: "STRING" }, hanzi_suggestion: { type: "STRING" }, pinyin_suggestion: { type: "STRING" } }, required: ["vietnamese_sentence", "hanzi_suggestion", "pinyin_suggestion"] } }),
            pinyinPractice: (input) => ({ prompt: `D·ª±a v√†o ch·ªß ƒë·ªÅ "${input}", h√£y t·∫°o m·ªôt c√¢u ti·∫øng Vi·ªát ƒë∆°n gi·∫£n v√† cung c·∫•p b·∫£n d·ªãch ti·∫øng Trung c·ªßa n√≥. Tr·∫£ v·ªÅ m·ªôt ƒë·ªëi t∆∞·ª£ng JSON v·ªõi c√°c kh√≥a: "vietnamese_sentence", "hanzi_suggestion", "pinyin_suggestion".`, schema: { type: "OBJECT", properties: { vietnamese_sentence: { type: "STRING" }, hanzi_suggestion: { type: "STRING" }, pinyin_suggestion: { type: "STRING" } }, required: ["vietnamese_sentence", "hanzi_suggestion", "pinyin_suggestion"] } }),
            checkPinyin: (vietnameseSentence, userPinyin, correctPinyin) => ({ prompt: `C√¢u g·ªëc ti·∫øng Vi·ªát l√†: "${vietnameseSentence}". Ng∆∞·ªùi d√πng ƒë√£ g√µ pinyin l√†: "${userPinyin}". Pinyin ƒë√∫ng g·ª£i √Ω l√†: "${correctPinyin}". H√£y ki·ªÉm tra xem pinyin ng∆∞·ªùi d√πng g√µ c√≥ ƒë√∫ng kh√¥ng (cho ph√©p c·∫£ pinyin c√≥ d·∫•u v√† kh√¥ng d·∫•u d·∫°ng s·ªë). N·∫øu sai, h√£y ƒë∆∞a ra ph·∫£n h·ªìi ng·∫Øn g·ªçn b·∫±ng ti·∫øng Vi·ªát. Tr·∫£ v·ªÅ JSON c√≥ kh√≥a: "is_correct" (boolean), "corrected_pinyin" (chu·ªói pinyin ƒë√∫ng), "feedback" (chu·ªói nh·∫≠n x√©t).`, schema: { type: "OBJECT", properties: { is_correct: { type: "BOOLEAN" }, corrected_pinyin: { type: "STRING" }, feedback: { type: "STRING" } }, required: ["is_correct", "corrected_pinyin", "feedback"] } }),
            comparison: (input) => ({ prompt: `So s√°nh c√°c t·ª´ Pinyin sau: "${input}". ƒê·ªëi v·ªõi m·ªói t·ª´, gi·∫£i th√≠ch s·∫Øc th√°i √Ω nghƒ©a kh√°c nhau v√† ng·ªØ c·∫£nh s·ª≠ d·ª•ng kh√°c nhau c·ªßa t·ª´ng t·ª´, c√°ch d√πng b·∫±ng ti·∫øng Vi·ªát, k√®m theo m·ªôt c√¢u v√≠ d·ª• (c·∫£ H√°n t·ª±, pinyin v√† b·∫£n d·ªãch ti·∫øng Vi·ªát). Tr·∫£ v·ªÅ m·∫£ng JSON, m·ªói ƒë·ªëi t∆∞·ª£ng c√≥ kh√≥a: "pinyin", "explanation", "example_hanzi", "example_pinyin", "example_vietnamese".`, schema: { type: "ARRAY", items: { type: "OBJECT", properties: { pinyin: { type: "STRING" }, explanation: { type: "STRING" }, example_hanzi: { type: "STRING" }, example_pinyin: { type: "STRING" }, example_vietnamese: { type: "STRING" } }, required: ["pinyin", "explanation", "example_hanzi", "example_pinyin", "example_vietnamese"] } } }),
            toneAnalysis: (input) => ({ prompt: `Ph√¢n t√≠ch thanh ƒëi·ªáu c·ªßa c√¢u Pinyin sau: "${input}". Cung c·∫•p gi·∫£i th√≠ch chung b·∫±ng ti·∫øng Vi·ªát. Sau ƒë√≥, li·ªát k√™ chi ti·∫øt t·ª´ng √¢m ti·∫øt v·ªõi s·ªë thanh ƒëi·ªáu, k√Ω hi·ªáu v√† m√¥ t·∫£. Tr·∫£ v·ªÅ JSON c√≥ kh√≥a: "original_pinyin", "explanation", "tones" (m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng c√≥ "syllable", "tone_number", "mark", "description").`, schema: { type: "OBJECT", properties: { original_pinyin: { type: "STRING" }, explanation: { type: "STRING" }, tones: { type: "ARRAY", items: { type: "OBJECT", properties: { syllable: { type: "STRING" }, tone_number: { type: "NUMBER" }, mark: { type: "STRING" }, description: { type: "STRING" } } } } }, required: ["original_pinyin", "explanation", "tones"] } }),
            situationalSentences: (input) => ({ prompt: `T·∫°o 3 c√¢u ti·∫øng Trung h·ªØu √≠ch cho t√¨nh hu·ªëng: "${input}". V·ªõi m·ªói c√¢u, cung c·∫•p ch·ªØ H√°n, pinyin v√† b·∫£n d·ªãch ti·∫øng Vi·ªát. Tr·∫£ v·ªÅ JSON c√≥ kh√≥a 'situation' v√† 'sentences' (m·∫£ng ƒë·ªëi t∆∞·ª£ng c√≥ 'hanzi', 'pinyin', 'vietnamese').`, schema: { type: "OBJECT", properties: { situation: { type: "STRING" }, sentences: { type: "ARRAY", items: { type: "OBJECT", properties: { hanzi: { type: "STRING" }, pinyin: { type: "STRING" }, vietnamese: { type: "STRING" } }, required: ["hanzi", "pinyin", "vietnamese"] } } }, required: ["situation", "sentences"] } }),
            translateViToZh: (input) => ({
                prompt: `D·ªãch c√¢u ti·∫øng Vi·ªát sau ƒë√¢y sang ti·∫øng Trung: "${input}". Cung c·∫•p 3-5 ph∆∞∆°ng √°n d·ªãch kh√°c nhau. V·ªõi m·ªói ph∆∞∆°ng √°n, h√£y cung c·∫•p: 1. Ch·ªØ H√°n (hanzi). 2. Pinyin c√≥ d·∫•u. 3. Tr·∫°ng th√°i ph·ªï bi·∫øn B·∫∞NG TI·∫æNG VI·ªÜT (v√≠ d·ª•: "R·∫•t ph·ªï bi·∫øn", "T·ª± nhi√™n", "H∆°i trang tr·ªçng", "√çt d√πng"). 4. M·ªôt ghi ch√∫ ng·∫Øn v·ªÅ ng·ªØ c·∫£nh s·ª≠ d·ª•ng B·∫∞NG TI·∫æNG VI·ªÜT. Tr·∫£ v·ªÅ m·ªôt m·∫£ng JSON c√°c ƒë·ªëi t∆∞·ª£ng c√≥ kh√≥a: "hanzi", "pinyin", "popularity_status", "usage_note".`,
                schema: { type: "ARRAY", items: { type: "OBJECT", properties: { hanzi: { type: "STRING" }, pinyin: { type: "STRING" }, popularity_status: { type: "STRING" }, usage_note: { type: "STRING" } }, required: ["hanzi", "pinyin", "popularity_status", "usage_note"] } }
            }),
            conversationTurn: (conversationContext, latestMessage) => ({ prompt: `ƒê√¢y l√† m·ªôt cu·ªôc h·ªôi tho·∫°i gi·ªØa AI 'Linh' v√† ng∆∞·ªùi h·ªçc ti·∫øng Trung. B·ªëi c·∫£nh: ${conversationContext}. Tin nh·∫Øn g·∫ßn nh·∫•t c·ªßa ng∆∞·ªùi d√πng (b·∫±ng pinyin): ${latestMessage}. H√£y ƒë√≥ng vai Linh v√† ph·∫£n h·ªìi m·ªôt c√°ch t·ª± nhi√™n b·∫±ng ti·∫øng Trung. Tr·∫£ v·ªÅ JSON c√≥ kh√≥a "hanzi", "pinyin", v√† "vietnamese".`, schema: { type: "OBJECT", properties: { hanzi: { type: "STRING" }, pinyin: { type: "STRING" }, vietnamese: { type: "STRING" } }, required: ["hanzi", "pinyin", "vietnamese"] } }),
            conversationCorrection: (pinyinSentence) => ({ prompt: `Ph√¢n t√≠ch c√¢u pinyin sau: "${pinyinSentence}". S·ª≠a l·∫°i n·∫øu c·∫ßn v√† gi·∫£i th√≠ch l·ªói b·∫±ng ti·∫øng Vi·ªát. Cung c·∫•p pinyin ƒë√£ s·ª≠a, ghi ch√∫ v√† b·∫£n d·ªãch. N·∫øu ƒë√∫ng, x√°c nh·∫≠n l√† ƒë√∫ng. Tr·∫£ v·ªÅ JSON v·ªõi kh√≥a "originalPinyin", "correctedPinyin", "isCorrect", "correctionNotes", "vietnameseTranslation".`, schema: { type: "OBJECT", properties: { originalPinyin: { type: "STRING" }, correctedPinyin: { type: "STRING" }, isCorrect: { type: "BOOLEAN" }, correctionNotes: { type: "STRING" }, vietnameseTranslation: { type: "STRING" } }, required: ["originalPinyin", "correctedPinyin", "isCorrect", "correctionNotes", "vietnameseTranslation"] } }),
        };

        // --- Function Triggers ---
        function generateExamples() { handleFeature('example', 'T·∫°o v√≠ d·ª•', prompts.examples, renderers.examples); }
        function generateExercise() { handleFeature('exercise', 'T·∫°o B√†i T·∫≠p Vi·∫øt', prompts.exercise, renderers.exercise); }
        function generateListeningFillInTheBlank() { handleFeature('listeningFillInTheBlank', 'B√†i t·∫≠p Nghe & ƒêi·ªÅn t·ª´', prompts.listeningFillInTheBlank, renderers.listeningFillInTheBlank); }
        function generateExplanation() { handleFeature('explanation', 'Gi·∫£i th√≠ch T·ª´ V·ª±ng', prompts.explanation, renderers.explanation); }
        function correctPinyin() { handleFeature('correction', 'S·ª≠a Pinyin', prompts.correction, renderers.correction); }
        function generateDialogue() { handleFeature('dialogue', 'T·∫°o ƒêo·∫°n H·ªôi Tho·∫°i', prompts.dialogue, renderers.dialogue); }
        function summarizeText() { handleFeature('summary', 'T√≥m T·∫Øt VƒÉn B·∫£n', prompts.summary, renderers.summary); }
        function generateParagraphs() { handleFeature('paragraph', 'Vi·∫øt ƒêo·∫°n VƒÉn', prompts.paragraphs, renderers.paragraphs, (input) => input.includes(',') || input.includes(' ')); }
        function checkPopularity() { handleFeature('popularity', 'Ki·ªÉm Tra M·ª©c ƒê·ªô Ph·ªï Bi·∫øn', prompts.popularity, renderers.popularity); }
        function translateSentence() { handleFeature('translation', 'D·ªãch c√¢u Vi·ªát - Trung', prompts.translateViToZh, renderers.translationResults); }
        function generateReadingAndQuestions() { handleFeature('reading', 'B√†i ƒê·ªçc & C√¢u H·ªèi', prompts.reading, renderers.reading); }
        function generateListeningAndQuestions() { handleFeature('listening', 'B√†i Nghe & C√¢u H·ªèi', prompts.listening, renderers.listening); }
        function startSpeakingPractice() { handleFeature('speakingPractice', 'Luy·ªán ph·∫£n x·∫° n√≥i', null, renderers.speakingPractice); }
        function startPinyinPractice() { handleFeature('pinyinPractice', 'Luy·ªán g√µ Pinyin', null, renderers.pinyinPractice); }
        function compareVocabulary() { handleFeature('comparison', 'So S√°nh T·ª´ V·ª±ng', prompts.comparison, renderers.comparison, (input) => input.split(',').length > 1); }
        function analyzeTones() { handleFeature('toneAnalysis', 'Ph√¢n T√≠ch Thanh ƒêi·ªáu', prompts.toneAnalysis, renderers.toneAnalysis); }
        function startConversationSimulator() { handleFeature('conversationSimulator', 'M√¥ ph·ªèng H·ªôi tho·∫°i', null, renderers.conversationSimulator); }
        function generateSituationalSentences() { handleFeature('situationalSentences', 'T·∫°o c√¢u theo T√¨nh hu·ªëng', prompts.situationalSentences, renderers.situationalSentences); }

        function startSpeakingPracticeManual() {
            const modal = document.getElementById('manualSpeakingModal');
            modal.style.display = 'flex';
            document.getElementById('startManualPracticeBtn').onclick = () => {
                const sentencesText = document.getElementById('manualSentencesInput').value.trim();
                const sentences = sentencesText.split('\n').map(s => s.trim()).filter(s => s.length > 0);
                if (sentences.length === 0) {
                    showMessage('Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt c√¢u ƒë·ªÉ luy·ªán t·∫≠p.', 'error');
                    return;
                }
                modal.style.display = 'none';
                handleFeature('speakingPracticeManual', 'Luy·ªán ph·∫£n x·∫° th·ªß c√¥ng', null,
                    (input, content, headerText) => renderers.speakingPracticeManual(sentences, content, headerText),
                    (input) => input.length > 0
                );
            };
            document.getElementById('closeManualSpeakingModal').onclick = () => { modal.style.display = 'none'; };
            modal.onclick = (event) => { if (event.target == modal) modal.style.display = 'none'; };
        }

        // --- Interactive Answer Checking ---
        function checkFillInBlankAnswer(button, correctWord) {
            const item = button.closest('.exercise-item');
            const feedback = item.querySelector('.exercise-feedback');
            const options = item.querySelectorAll('.option-btn');
            const hanziSentence = item.dataset.hanzi;

            options.forEach(btn => btn.disabled = true);

            const speakButtonHTML = hanziSentence
                ? `<button class="icon-btn" onclick="speakText('${hanziSentence.replace(/'/g, "\\'")}')" title="Nghe l·∫°i"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-1.414 1.414A6.472 6.472 0 0 1 12.026 8c0 1.966-.893 3.738-2.29 4.949l1.414 1.414z"/></svg></button>`
                : '';

            if (button.dataset.value === correctWord) {
                button.classList.add('correct');
                feedback.innerHTML = `Ch√≠nh x√°c! üéâ ${speakButtonHTML}`;
            } else {
                button.classList.add('incorrect');
                feedback.innerHTML = `Sai r·ªìi. ƒê√°p √°n ƒë√∫ng l√† "<b class="font-mono">${correctWord}</b>". ${speakButtonHTML}`;
                const correctButton = item.querySelector(`button[data-value="${correctWord.replace(/"/g, '&quot;')}"]`);
                if (correctButton) correctButton.classList.add('correct');
            }
        }

        function checkMultipleChoiceAnswer(button) {
            const item = button.closest('.question-item');
            const feedbackEl = item.querySelector('.question-feedback');
            const correctAnswer = item.dataset.correctAnswer;
            const questionTranslation = item.dataset.questionTranslation;

            item.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);

            if (button.textContent === correctAnswer) {
                button.classList.add('correct');
                feedbackEl.innerHTML = `Ch√≠nh x√°c! üéâ <br><span class="question-translation">(C√¢u h·ªèi: ${questionTranslation})</span>`;
            } else {
                button.classList.add('incorrect');
                const correctBtn = Array.from(item.querySelectorAll('.option-btn')).find(b => b.textContent === correctAnswer);
                if (correctBtn) correctBtn.classList.add('correct');
                feedbackEl.innerHTML = `Sai r·ªìi. ƒê√°p √°n ƒë√∫ng l√†: "<b class="font-mono">${correctAnswer}</b>" <br><span class="question-translation">(C√¢u h·ªèi: ${questionTranslation})</span>`;
            }
        }

        // --- Audio Player & Speech Recognition Logic ---
        function createChineseUtterance(textInHanzi, { showError = true } = {}) {
            const utterance = new SpeechSynthesisUtterance(textInHanzi);
            const voices = speechSynthesis.getVoices().filter(voice => voice.lang.startsWith('zh'));
            if (voices.length === 0) {
                if (showError) {
                    showMessage('Kh√¥ng t√¨m th·∫•y gi·ªçng ƒë·ªçc Ti·∫øng Trung tr√™n tr√¨nh duy·ªát n√†y.', 'error');
                }
                return null;
            }
            utterance.voice = voices.find(v => v.name.includes('Google') && v.lang === 'zh-CN') || voices.find(v => v.lang === 'zh-CN') || voices[0];
            utterance.lang = 'zh-CN';
            utterance.rate = 0.9;
            return utterance;
        }

        function speakText(textInHanzi) {
            if (!('speechSynthesis' in window)) {
                showMessage('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ph√°t √¢m thanh.', 'error');
                return;
            }
            stopLoopPlayback();
            if (speechSynthesis.speaking && !isSpeakingFullDialogue) {
                speechSynthesis.cancel();
            }
            const utterance = createChineseUtterance(textInHanzi);
            if (!utterance) return;
            utterance.onerror = (event) => console.error("L·ªói ph√°t √¢m thanh:", event);
            speechSynthesis.speak(utterance);
        }

        function playQuestionAudio(button, textInHanzi) {
            if (!('speechSynthesis' in window)) return;
            if (speechSynthesis.speaking) speechSynthesis.cancel();
            const utterance = createChineseUtterance(textInHanzi);
            if (!utterance) return;

            const originalIconSVG = button.innerHTML;
            button.innerHTML = `<div class="spinning-loader"></div>`;
            button.disabled = true;
            utterance.onend = () => { button.innerHTML = originalIconSVG; button.disabled = false; };
            utterance.onerror = (e) => { button.innerHTML = originalIconSVG; button.disabled = false; console.error("L·ªói ph√°t √¢m:", e); };
            speechSynthesis.speak(utterance);
        }

        function toggleLoopPlayback(button, textInHanzi) {
            if (!textInHanzi) return;
            if (!('speechSynthesis' in window)) {
                showMessage('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ph√°t √¢m thanh.', 'error');
                return;
            }
            if (loopPlaybackState.active && loopPlaybackState.button === button) {
                stopLoopPlayback();
                return;
            }
            startLoopPlayback(button, textInHanzi);
        }

        function startLoopPlayback(button, textInHanzi) {
            stopLoopPlayback();
            loopPlaybackState.active = true;
            loopPlaybackState.text = textInHanzi;
            loopPlaybackState.button = button;
            if (!button.dataset.loopDefault) {
                button.dataset.loopDefault = button.innerHTML;
            }
            button.dataset.loopState = 'playing';
            button.innerHTML = button.dataset.loopStop || '‚èπ D·ª´ng l·∫∑p';
            playLoopUtterance();
        }

        function playLoopUtterance() {
            if (!loopPlaybackState.active) return;
            const utterance = createChineseUtterance(loopPlaybackState.text, { showError: !loopPlaybackState.button });
            if (!utterance) {
                stopLoopPlayback();
                return;
            }
            utterance.onend = () => {
                if (loopPlaybackState.active) {
                    setTimeout(playLoopUtterance, 250);
                }
            };
            utterance.onerror = (err) => {
                console.error('Loop playback error:', err);
                stopLoopPlayback();
            };
            speechSynthesis.speak(utterance);
        }

        function stopLoopPlayback() {
            if (loopPlaybackState.active && 'speechSynthesis' in window) {
                speechSynthesis.cancel();
            }
            if (loopPlaybackState.button) {
                const btn = loopPlaybackState.button;
                const defaultHtml = btn.dataset.loopDefault || 'üîÅ Nghe li√™n t·ª•c';
                btn.innerHTML = defaultHtml;
                btn.dataset.loopState = 'stopped';
            }
            loopPlaybackState.active = false;
            loopPlaybackState.text = '';
            loopPlaybackState.button = null;
        }

        function setupAudioPlayer(scriptInHanzi, container) {
            container.innerHTML = `<div class="audio-player"><div class="audio-controls"><button id="audioPlayBtn" class="audio-btn" title="Ph√°t"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M10.804 8 5 4.633v6.734L10.804 8zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm15 0a7 7 0 1 0-14 0 7 7 0 0 0 14 0z"/></svg></button><button id="audioPauseBtn" class="audio-btn" title="T·∫°m d·ª´ng" style="display: none;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M6 3.5a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V4a.5.5 0 0 1 .5-.5zm4 0a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V4a.5.5 0 0 1 .5-.5zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm15 0a7 7 0 1 0-14 0 7 7 0 0 0 14 0z"/></svg></button><button id="audioStopBtn" class="audio-btn" title="D·ª´ng"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v4a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm5 0a.5.5 0 0 1 0 1H6.5a.5.5 0 0 1 0-1H10.5zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm15 0a7 7 0 1 0-14 0 7 7 0 0 0 14 0z"/></svg></button></div><div id="audioStatus" class="audio-status">S·∫µn s√†ng</div></div>`;
            const playBtn = document.getElementById('audioPlayBtn'), pauseBtn = document.getElementById('audioPauseBtn'), stopBtn = document.getElementById('audioStopBtn'), statusDiv = document.getElementById('audioStatus');
            if (!('speechSynthesis' in window)) { statusDiv.textContent = 'Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£'; playBtn.disabled = true; return; }

            let utterance = new SpeechSynthesisUtterance(scriptInHanzi);
            const setVoice = () => {
                const voices = speechSynthesis.getVoices().filter(voice => voice.lang.startsWith('zh'));
                if (voices.length > 0) { utterance.voice = voices.find(v => v.name.includes('Google') && v.lang === 'zh-CN') || voices.find(v => v.lang === 'zh-CN') || voices[0]; utterance.lang = 'zh-CN'; }
            };
            setVoice();
            if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = setVoice;

            utterance.onstart = () => { statusDiv.textContent = 'ƒêang ph√°t...'; playBtn.style.display = 'none'; pauseBtn.style.display = 'flex'; };
            utterance.onpause = () => { statusDiv.textContent = 'ƒê√£ t·∫°m d·ª´ng'; playBtn.style.display = 'flex'; pauseBtn.style.display = 'none'; };
            utterance.onresume = () => { statusDiv.textContent = 'ƒêang ph√°t...'; playBtn.style.display = 'none'; pauseBtn.style.display = 'flex'; };
            utterance.onend = () => { statusDiv.textContent = 'ƒê√£ k·∫øt th√∫c'; playBtn.style.display = 'flex'; pauseBtn.style.display = 'none'; };
            utterance.onerror = (e) => { console.error(e); statusDiv.textContent = 'L·ªói ph√°t √¢m'; playBtn.style.display = 'flex'; pauseBtn.style.display = 'none'; };

            playBtn.addEventListener('click', () => { if (speechSynthesis.paused) { speechSynthesis.resume(); } else { speechSynthesis.cancel(); setTimeout(() => speechSynthesis.speak(utterance), 100); } });
            pauseBtn.addEventListener('click', () => { if (speechSynthesis.speaking) speechSynthesis.pause(); });
            stopBtn.addEventListener('click', () => { if (speechSynthesis.speaking || speechSynthesis.paused) speechSynthesis.cancel(); });
        }

        async function handlePronunciationRecording(sentenceData) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                showMessage('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ nh·∫≠n d·∫°ng gi·ªçng n√≥i.', 'error');
                return;
            }

            const recordBtn = document.getElementById('record-pronunciation-btn');
            const scoreContainer = document.getElementById('pronunciation-score-container');
            if (isRecording) { if (recognition) recognition.stop(); return; }

            let targetData = sentenceData;

            // Fetch suggestion if not already present
            if (!targetData.hanzi_suggestion) {
                scoreContainer.innerHTML = '<p class="text-center font-semibold">ƒêang l·∫•y c√¢u g·ª£i √Ω...</p>';
                scoreContainer.classList.remove('hidden');
                try {
                    const { prompt, schema } = prompts.speakingPractice(targetData.vietnamese_sentence);
                    targetData = await callGemini(prompt, schema);
                    scoreContainer.classList.add('hidden');
                    scoreContainer.innerHTML = '';
                } catch (error) {
                    showMessage('Kh√¥ng th·ªÉ l·∫•y c√¢u g·ª£i √Ω ƒë·ªÉ ch·∫•m ƒëi·ªÉm.', 'error');
                    scoreContainer.classList.add('hidden');
                    return;
                }
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN'; // Set to Mandarin Chinese
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            const recordBtnSpan = recordBtn.querySelector('span');
            recognition.onstart = () => {
                isRecording = true;
                recordBtn.classList.add('recording');
                recordBtnSpan.textContent = 'ƒêang ghi √¢m...';
                scoreContainer.classList.add('hidden');
            };

            recognition.onresult = async (event) => {
                const spokenTextHanzi = event.results[0][0].transcript;
                scoreContainer.innerHTML = '<p class="text-center font-semibold">ƒêang chuy·ªÉn sang Pinyin & ch·∫•m ƒëi·ªÉm...</p>';
                scoreContainer.classList.remove('hidden');

                try {
                    // Convert recognized Hanzi to Pinyin for display
                    const { prompt: pinyinPrompt, schema: pinyinSchema } = prompts.convertToPinyin(spokenTextHanzi);
                    const pinyinResult = await callGemini(pinyinPrompt, pinyinSchema);
                    const spokenTextPinyin = pinyinResult.pinyin;

                    // Get score using original Hanzi for accuracy
                    const { prompt: scorePrompt, schema: scoreSchema } = prompts.pronunciationScore(targetData.hanzi_suggestion, spokenTextHanzi);
                    const result = await callGemini(scorePrompt, scoreSchema);

                    // Display result with Pinyin
                    scoreContainer.innerHTML = `
                        <div class="pronunciation-score-card">
                            <div class="score-circle">${result.score}%</div>
                            <h4 class="card-title-alt">B·∫°n ƒë√£ n√≥i (Pinyin):</h4>
                            <p class="text-lg italic font-mono">"${spokenTextPinyin}"</p>
                            <h4 class="card-title-alt mt-4">C√¢u tr·∫£ l·ªùi g·ª£i √Ω (Pinyin):</h4>
                            <p class="text-lg font-medium text-green-600 font-mono">"${targetData.pinyin_suggestion}"</p>
                            <h4 class="card-title-alt mt-4">Nh·∫≠n x√©t c·ªßa AI:</h4>
                            <p>${result.feedback}</p>
                        </div>
                    `;

                } catch (error) {
                    console.error('L·ªói ch·∫•m ƒëi·ªÉm ph√°t √¢m:', error);
                    scoreContainer.innerHTML = `<p class="text-red-500">L·ªói khi x·ª≠ l√Ω k·∫øt qu·∫£: ${error.message}</p>`;
                }
            };
            recognition.onerror = (event) => { showMessage(`L·ªói ghi √¢m: ${event.error}`, 'error'); };
            recognition.onend = () => {
                isRecording = false;
                recordBtn.classList.remove('recording');
                recordBtnSpan.textContent = 'Ghi √¢m & Ch·∫•m ƒëi·ªÉm';
            };
            recognition.start();
        }

        function playFullDialogue(hanziLines) {
            if (!('speechSynthesis' in window)) return;
            if (speechSynthesis.speaking || speechSynthesis.pending) speechSynthesis.cancel();

            isSpeakingFullDialogue = true;
            currentUtteranceQueue = [...hanziLines];
            if (isRecording) { if (recognition) recognition.stop(); }

            const speakNextLine = () => {
                if (currentUtteranceQueue.length > 0 && isSpeakingFullDialogue) {
                    const line = currentUtteranceQueue.shift();
                    const utterance = new SpeechSynthesisUtterance(line);
                    const voices = speechSynthesis.getVoices().filter(voice => voice.lang.startsWith('zh'));
                    if (voices.length > 0) {
                        utterance.voice = voices.find(v => v.name.includes('Google') && v.lang === 'zh-CN') || voices[0];
                        utterance.lang = 'zh-CN';
                        utterance.rate = 0.9;
                    }
                    utterance.onend = () => speakNextLine();
                    utterance.onerror = (e) => { console.error(e); speakNextLine(); };
                    speechSynthesis.speak(utterance);
                } else {
                    isSpeakingFullDialogue = false;
                }
            };
            speakNextLine();
        }

        // --- Conversation Simulator Logic ---
        async function getNextAiResponse() {
            const chatInput = document.getElementById('chatInput');
            const chatSendButton = document.getElementById('chatSendButton');
            try {
                const context = conversationHistory.map(turn => `${turn.role}: ${turn.parts[0].text}`).join('\n');
                const lastUserMessage = conversationHistory.length > 1 ? conversationHistory[conversationHistory.length - 1].parts[0].text : "(b·∫Øt ƒë·∫ßu)";
                const { prompt, schema } = prompts.conversationTurn(context, lastUserMessage);
                const aiResponse = await callGemini(prompt, schema);

                const modelResponse = { role: 'model', parts: [{ text: aiResponse.hanzi }] };
                conversationHistory.push(modelResponse);
                addMessageToUI(aiResponse.pinyin, aiResponse.vietnamese, 'ai', aiResponse.hanzi);
            } catch (error) {
                console.error("L·ªói h·ªôi tho·∫°i:", error);
                addMessageToUI('Du√¨b√πq«ê, w«í h«éoxi√†ng y«íudi«én w√®nt√≠.', 'Xin l·ªói, t√¥i c√≥ ch√∫t v·∫•n ƒë·ªÅ.', 'ai', 'ÂØπ‰∏çËµ∑ÔºåÊàëÂ•ΩÂÉèÊúâÁÇπÈóÆÈ¢ò„ÄÇ');
            } finally {
                if (chatInput) chatInput.disabled = false;
                if (chatSendButton) chatSendButton.disabled = false;
            }
        }

        function addMessageToUI(pinyinText, vietnameseTranslation, sender, hanziText) {
            const messageArea = document.getElementById('messageArea');
            if (!messageArea) return;
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.innerHTML = `
                <div class="flex items-start justify-between">
                    <div>
                        <span class="font-mono">${pinyinText}</span>
                        <p class="translation">(D·ªãch: ${vietnameseTranslation})</p>
                    </div>
                     <button class="icon-btn" onclick="speakText('${hanziText.replace(/'/g, "\\'")}')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-1.414 1.414A6.472 6.472 0 0 1 12.026 8c0 1.966-.893 3.738-2.29 4.949l1.414 1.414z"/></svg>
                    </button>
                </div>
            `;
            messageArea.appendChild(messageDiv);
            messageArea.scrollTop = messageArea.scrollHeight;
        }

        async function continueConversation() {
            const chatInput = document.getElementById('chatInput');
            const chatSendButton = document.getElementById('chatSendButton');
            if (!chatInput) return;

            const userMessagePinyin = chatInput.value.trim();
            if (!userMessagePinyin) return;

            chatInput.disabled = true;
            if (chatSendButton) chatSendButton.disabled = true;

            const userTurn = { role: 'user', parts: [{ text: userMessagePinyin }] };
            conversationHistory.push(userTurn);

            // We show the user's pinyin immediately, but we need Hanzi and translation for the bubble
            // We can show a temporary message and update it
            addMessageToUI(userMessagePinyin, "ƒêang d·ªãch...", 'user', '');


            try {
                const { prompt, schema } = prompts.conversationCorrection(userMessagePinyin);
                const correctionResult = await callGemini(prompt, schema);

                // Update the user's last message bubble with the corrected info
                const lastMessageBubble = document.querySelector('.chat-message.user:last-child');
                if (lastMessageBubble) {
                    addMessageToUI(userMessagePinyin, correctionResult.vietnameseTranslation, 'user', '');
                    lastMessageBubble.remove(); // remove the temporary one
                }

                if (!correctionResult.isCorrect) {
                    showCorrectionModal(correctionResult);
                }
            } catch (error) {
                console.error("L·ªói ki·ªÉm tra ng·ªØ ph√°p:", error);
            }

            chatInput.value = '';
            await getNextAiResponse();
        }

        function showCorrectionModal(data) {
            modalCorrectionContent.innerHTML = `
                <div class="table-container">
                <table class="correction-table w-full">
                    <tr> <th class="w-1/3">M·ª•c</th> <th>N·ªôi dung</th> </tr>
                    <tr> <td>üì• Pinyin g·ªëc</td> <td class="font-mono">${data.originalPinyin}</td> </tr>
                    <tr> <td>‚úÖ Pinyin ƒë√£ s·ª≠a</td> <td class="font-mono">${data.correctedPinyin}</td> </tr>
                    <tr> <td>üõ†Ô∏è Ghi ch√∫</td> <td>${data.correctionNotes}</td> </tr>
                    <tr> <td>üá≥ D·ªãch nghƒ©a</td> <td>${data.vietnameseTranslation}</td> </tr>
                </table>
                </div>
            `;
            correctionModal.style.display = 'flex';
        }

        async function quickSearch() {
            const input = vocabularyInput.value.trim();
            if (!input) {
                showMessage('Vui l√≤ng nh·∫≠p t·ª´ ho·∫∑c c·ª•m t·ª´ ƒë·ªÉ tra c·ª©u.', 'error');
                return;
            }
            hideAllSections();
            quickSearchResults.innerHTML = `<div class="info-card p-4 flex items-center justify-center"> <div class="loading-spinner"></div> <span class="ml-3 text-gray-600 dark:text-gray-300">ƒêang tra c·ª©u...</span> </div>`;

            try {
                const { prompt, schema } = prompts.quickLookup(input);
                const data = await callGemini(prompt, schema);
                renderers.quickLookup(data, quickSearchResults);
                speakText(data.hanzi);
            } catch (error) {
                showMessage('Kh√¥ng th·ªÉ tra c·ª©u. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
                console.error('L·ªói tra c·ª©u nhanh:', error);
                quickSearchResults.innerHTML = `<div class="info-card p-4 text-center text-red-600 dark:text-red-400">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ cho "${input}".</div>`;
            }
        }

        // --- Event Listeners ---
        function attachEventListeners() {
            document.getElementById('btnClearInput').addEventListener('click', clearInput);
            document.getElementById('btnPasteClipboard').addEventListener('click', pasteFromClipboard);
            document.getElementById('btnQuickSearch').addEventListener('click', quickSearch);

            // Learn & Practice
            document.getElementById('btnGenerateExplanation').addEventListener('click', generateExplanation);
            document.getElementById('btnGenerateExamples').addEventListener('click', generateExamples);
            document.getElementById('btnGenerateExercise').addEventListener('click', generateExercise);
            document.getElementById('btnGenerateListeningFillInTheBlank').addEventListener('click', generateListeningFillInTheBlank);
            document.getElementById('btnGenerateReadingAndQuestions').addEventListener('click', generateReadingAndQuestions);
            document.getElementById('btnGenerateListeningAndQuestions').addEventListener('click', generateListeningAndQuestions);

            // Create
            document.getElementById('btnCorrectPinyin').addEventListener('click', correctPinyin);
            document.getElementById('btnGenerateDialogue').addEventListener('click', generateDialogue);
            document.getElementById('btnGenerateParagraphs').addEventListener('click', generateParagraphs);
            document.getElementById('btnSummarizeText').addEventListener('click', summarizeText);
            document.getElementById('btnGenerateSituationalSentences').addEventListener('click', generateSituationalSentences);

            // Analyze
            document.getElementById('btnCompareVocabulary').addEventListener('click', compareVocabulary);
            document.getElementById('btnAnalyzeTones').addEventListener('click', analyzeTones);
            document.getElementById('btnCheckPopularity').addEventListener('click', checkPopularity);
            document.getElementById('btnTranslateSentence').addEventListener('click', translateSentence);


            // Interactive
            document.getElementById('btnStartConversationSimulator').addEventListener('click', startConversationSimulator);
            document.getElementById('btnStartSpeakingPractice').addEventListener('click', startSpeakingPractice);
            document.getElementById('btnStartPinyinPractice').addEventListener('click', startPinyinPractice);
            document.getElementById('btnStartSpeakingPracticeManual').addEventListener('click', startSpeakingPracticeManual);

            // External Links
            document.getElementById('btnGoogleTranslate').addEventListener('click', () => openLink('googleTranslate'));
            document.getElementById('btnPleco').addEventListener('click', () => openLink('pleco'));
            document.getElementById('btnForvo').addEventListener('click', () => openLink('forvo'));
            document.getElementById('btnGoogleImages').addEventListener('click', () => openLink('googleImages'));
            document.getElementById('btnYouglish').addEventListener('click', () => openLink('youglish'));

            // Modals
            closeCorrectionModalBtn.addEventListener('click', () => { correctionModal.style.display = 'none'; });
            window.addEventListener('click', (event) => { if (event.target == correctionModal) { correctionModal.style.display = 'none'; } });
        }
    </script>
</body>

</html>